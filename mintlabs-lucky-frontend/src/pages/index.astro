---
/**
 * MintLabs Lucky Numbers - Homepage
 * Polished ball-based layout with theme switching and 3 accordions
 */
import Layout from '../layouts/Layout.astro';
import GeneratorFormPolished from '../components/demo/GeneratorFormPolished.astro';
import GameFacts from '../components/GameFacts.astro';
import HomeAccordions from '../components/home/HomeAccordions.astro';
import TermsModal from '../components/TermsModal.astro';
import PrivacyModal from '../components/PrivacyModal.astro';
import NewsletterModal from '../components/NewsletterModal.astro';
import { apiUrl, API_BASE } from '../lib/api/base';

const ADS = import.meta.env.PUBLIC_ADSENSE_CLIENT;
const IS_PROD = import.meta.env.PROD;

// Build-time/SSR uses BACKEND_ORIGIN (absolute), browser uses /api (relative)
const gamesEndpoint = apiUrl('/games');
const games = await fetch(gamesEndpoint).then(r => r.json()).catch(() => []);
const jsonGames = Array.isArray(games) ? JSON.stringify(games).replaceAll('`', '\\`') : '[]';
const current = Array.isArray(games) && games.length > 0 ? games[0] : null;
// Client-side uses API_BASE (/api proxy)
const apiBase = API_BASE;
---

<Layout title="Lucky Numbers" description="Generate random lottery numbers for education and entertainment. Explore probability tools, casino simulators, and lottery math.">
  {jsonGames && jsonGames !== '[]' && (
    <script type="application/json" id="initial-games" set:html={jsonGames} />
  )}

  <main class="mx-auto max-w-[var(--content-max-width)] px-4 sm:px-6 space-y-6">
    <header class="pt-3">
      <div class="flex items-center justify-center gap-3 md:gap-4">
        <a href="/" class="flex min-w-0 items-center gap-3 md:gap-4 hover:opacity-90 transition-opacity">
          <img src="/clover.png" alt="Lucky Clover" class="w-12 h-12 md:w-14 md:h-14 shrink-0" />
          <h1 class="min-w-0 max-w-full overflow-hidden text-ellipsis whitespace-nowrap text-3xl md:text-4xl font-bold leading-tight">
          Lucky Number Today
          </h1>
        </a>
      </div>
      <p class="hidden sm:block mt-1 text-center theme-text-secondary text-sm">
        For education and entertainment only. Play responsibly.
      </p>

      <nav class="mt-4 flex flex-wrap justify-center gap-2 md:gap-4">
        <a href="/tools" class="nav-pill">Tools</a>
        <a href="/casino-lite" class="nav-pill">Casino-Lite</a>
        <a href="/lottery-odds" class="nav-pill">Odds</a>
        <a href="/lottery-math" class="nav-pill">Math</a>
        <a href="/faq" class="nav-pill">FAQ</a>
      </nav>
    </header>

    <!-- Theme selector (desktop) -->
    <div class="hidden sm:flex flex-col sm:flex-row sm:items-center justify-center gap-2 mt-2 mb-2">
      <label for="themeSelectDesktop" class="sr-only">Theme</label>
      <select id="themeSelectDesktop"
        class="w-full sm:w-auto shrink-0 theme-bg-card theme-text-primary theme-border-primary border
               rounded-lg h-9 px-3 pr-8 bg-clip-padding backdrop-blur-sm text-sm focus:outline-none
               focus:ring-2 focus:ring-[var(--accent-primary)]">
        <option value="blue-dark">Classic</option>
        <option value="green-dark">Alpine</option>
        <option value="purple-dark">Perilla</option>
        <option value="amber-dark">Eau de Cologne</option>
        <option value="red-dark">Red</option>
        <option value="teal-dark">Teal</option>
        <option value="bw-dark">Monochrome</option>
        <option value="blue-light">Classic Light</option>
        <option value="green-light">Alpine Light</option>
        <option value="purple-light">Perilla Light</option>
        <option value="amber-light">Eau de Cologne Light</option>
        <option value="red-light">Red Light</option>
        <option value="teal-light">Teal Light</option>
        <option value="bw-light">Monochrome Light</option>
      </select>
    </div>

    <!-- Generator Form -->
    <div class="my-8">
      <GeneratorFormPolished games={Array.isArray(games) ? games : []} />
    </div>

    <!-- Results Section -->
    <section id="results" class="space-y-3"></section>

    <!-- Contextual discovery link (shown after results) -->
    <div id="contextual-discovery" class="hidden">
      <a href="/lottery-odds" class="text-sm underline theme-text-muted hover:theme-text-secondary transition-colors">
        Why these odds? &rarr;
      </a>
    </div>

    <!-- Game Facts -->
    <div id="facts" class="mt-3">
      {current && <GameFacts game={current} />}
    </div>

    {IS_PROD && ADS && (
      <>
        <script async src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${ADS}`} crossorigin="anonymous"></script>
        <ins class="adsbygoogle block h-[90px]" data-ad-client={ADS} data-ad-slot="0000000001" data-full-width-responsive="true"></ins>
        <script is:inline>try{(window.adsbygoogle=window.adsbygoogle||[]).push({});}catch(e){ console.debug(e); }</script>
      </>
    )}

    <!-- Three Accordions: Casino-Lite, Tools, Learn More -->
    <HomeAccordions />

    <!-- Footer -->
    <footer class="mt-12 pb-8 border-t border-slate-700/50 pt-8">
      <div class="grid gap-6 grid-cols-2 md:grid-cols-3 mb-6 text-sm">
        <div>
          <h4 class="font-semibold theme-text-secondary mb-2">Education</h4>
          <ul class="space-y-1.5 theme-text-muted">
            <li><a href="/lottery-odds" class="hover:text-emerald-400 transition-colors">Lottery Odds</a></li>
            <li><a href="/lottery-math" class="hover:text-emerald-400 transition-colors">The Math</a></li>
            <li><a href="/faq" class="hover:text-emerald-400 transition-colors">FAQ</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold theme-text-secondary mb-2">Tools</h4>
          <ul class="space-y-1.5 theme-text-muted">
            <li><a href="/tools" class="hover:text-emerald-400 transition-colors">All Tools</a></li>
            <li><a href="/tools/payout-calculator" class="hover:text-emerald-400 transition-colors">Payout Calculator</a></li>
            <li><a href="/tools/lottery-budget" class="hover:text-emerald-400 transition-colors">Budget Planner</a></li>
          </ul>
        </div>
        <div class="col-span-2 md:col-span-1">
          <h4 class="font-semibold theme-text-secondary mb-2">Legal</h4>
          <ul class="space-y-1.5 theme-text-muted">
            <li><a href="/terms" class="hover:text-emerald-400 transition-colors">Terms & Conditions</a></li>
            <li><a href="/privacy" class="hover:text-emerald-400 transition-colors">Privacy Policy</a></li>
          </ul>
        </div>
      </div>

      <!-- Mobile theme selector -->
      <div class="sm:hidden mb-6">
        <label for="themeSelectMobile" class="text-xs theme-text-muted mb-1 block">Theme</label>
        <select id="themeSelectMobile"
          class="w-full theme-bg-card theme-text-primary theme-border-primary border
                 rounded-lg h-10 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]">
          <option value="blue-dark">Classic</option>
          <option value="green-dark">Alpine</option>
          <option value="purple-dark">Perilla</option>
          <option value="amber-dark">Eau de Cologne</option>
          <option value="red-dark">Red</option>
          <option value="teal-dark">Teal</option>
          <option value="bw-dark">Monochrome</option>
          <option value="blue-light">Classic Light</option>
          <option value="green-light">Alpine Light</option>
          <option value="purple-light">Perilla Light</option>
          <option value="amber-light">Eau de Cologne Light</option>
          <option value="red-light">Red Light</option>
          <option value="teal-light">Teal Light</option>
          <option value="bw-light">Monochrome Light</option>
        </select>
      </div>

      <div class="text-center text-sm theme-text-muted border-t border-slate-700/50 pt-4">
        <p>&copy; 2025 MintLabs. All rights reserved.</p>
        <div class="mt-2 flex items-center justify-center gap-2 text-xs theme-text-muted">
          <img src="/mintlab.png" alt="MintLabs" class="w-4 h-4 opacity-70" />
          <span>Powered by MintLabs</span>
        </div>
        <p class="mt-2 text-xs theme-text-muted max-w-sm mx-auto">
          For entertainment and education only. We do not predict lottery numbers. Play responsibly.
        </p>
      </div>
    </footer>

    {IS_PROD && ADS && (
      <>
        <script async src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${ADS}`} crossorigin="anonymous"></script>
        <ins class="adsbygoogle block h-[90px]" data-ad-client={ADS} data-ad-slot="0000000002" data-full-width-responsive="true"></ins>
        <script is:inline>try{(window.adsbygoogle=window.adsbygoogle||[]).push({});}catch(e){ console.debug(e); }</script>
      </>
    )}
  </main>

  <TermsModal />
  <PrivacyModal />
  <NewsletterModal />

  <script is:inline define:vars={{ apiBase }}>
    window.__LUCKY_API_BASE = apiBase;
  </script>
  <script>
    import { initLuckyDemoBalls } from '../scripts/lucky.demo-balls';
    import { track } from '../scripts/tracking';

    if (typeof document !== 'undefined') {
      const boot = () => {
        initLuckyDemoBalls();
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', boot, { once: true });
      } else {
        boot();
      }
    }

    if (typeof window !== 'undefined') {
      try {
        (window as any).track = track;
      } catch (err) { console.debug(err); }
    }

    if (typeof window !== 'undefined') {
      try {
        document.addEventListener('click', (ev) => {
          try {
            let tgt: EventTarget | null = ev.target;
            if (!(tgt instanceof Element)) tgt = ((tgt as any)?.parentElement) || null;
            if (!tgt) return;
            const el = (tgt as Element).closest('[data-track-event]');
            if (!el) return;
            const eventName = (el as HTMLElement).dataset.trackEvent || 'link_click';
            let props: Record<string, any> = {};
            if ((el as HTMLElement).dataset.trackProps) {
              try { props = JSON.parse((el as HTMLElement).dataset.trackProps || '{}'); } catch (err) { console.debug(err); props = {}; }
            }
            if (typeof track === 'function') track(eventName, { href: el.getAttribute?.('href'), ...props });
          } catch (err) { console.debug(err); }
        }, { passive: true });
      } catch (err) { console.debug(err); }
    }
  </script>
</Layout>

<style>
  :root {
    --content-max-width: 36rem;
  }
  :root {
    --bg-card-solid: #1e293b;
  }
  [data-theme="green-dark"] {
    --bg-card-solid: #065f46;
  }
  [data-theme="blue-dark"] {
    --bg-card-solid: #1e293b;
  }
  [data-theme="purple-dark"] {
    --bg-card-solid: #3b2d7a;
  }
  [data-theme$="-light"] {
    --bg-card-solid: #f1f5f9;
  }

  .nav-pill {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 9999px;
    border: 1px solid var(--border-primary);
    background: var(--surface, rgba(255, 255, 255, 0.02));
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .nav-pill:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  #contextual-discovery { text-align: center; padding: 0.5rem 0; }

  /* Four-corner layout + ball row styling */
  .ln-resultCard { position: relative; overflow: hidden; padding: clamp(0.85rem, 1vw + 0.5rem, 1.15rem); width: 100%; }
  .ln-cardInner { width: 100%; display: grid; grid-template-rows: auto 1fr auto; gap: 0.35rem; align-self: stretch; align-items: stretch; }
  .ln-cardHeader,
  .ln-cardFooter {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: start;
    gap: 0.5rem;
    width: 100%;
  }
  .ln-cardFooter { align-items: end; }
  .ln-hLeft,
  .ln-fLeft { min-width: 0; }
  .ln-hRight,
  .ln-fRight { justify-self: end; text-align: right; white-space: nowrap; }
  .ln-cardCenter { display: flex; align-items: center; justify-content: center; padding: 0.15rem 0.25rem; width: 100%; }

  @media (max-width: 640px) {
    .ln-cardGrid { gap: 0.3rem 0.5rem; }
    .ln-cardCorner { font-size: 0.88rem; }
  }
</style>

<style is:global>
  /* Enforce 4-corner grid for result cards */
  .result-card.ln-resultCard .ln-cardInner {
    display: grid !important;
    grid-template-rows: auto 1fr auto !important;
    width: 100% !important;
  }
  .result-card.ln-resultCard .ln-cardHeader,
  .result-card.ln-resultCard .ln-cardFooter {
    display: grid !important;
    grid-template-columns: 1fr auto !important;
    width: 100% !important;
    align-items: end !important;
  }
  .result-card.ln-resultCard .ln-hLeft,
  .result-card.ln-resultCard .ln-fLeft {
    min-width: 0 !important;
  }
  .result-card.ln-resultCard .ln-hRight,
  .result-card.ln-resultCard .ln-fRight {
    justify-self: end !important;
    text-align: right !important;
    white-space: nowrap;
    align-self: end !important;
  }
</style>

<script is:inline>
  (function() {
    const selDesktop = document.getElementById('themeSelectDesktop');
    const selMobile = document.getElementById('themeSelectMobile');
    const apply = (t) => {
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('selectedTheme', t);
      if (selDesktop) selDesktop.value = t;
      if (selMobile) selMobile.value = t;
    };

    const saved = document.documentElement.getAttribute('data-theme') || localStorage.getItem('selectedTheme') || 'blue-dark';
    apply(saved);

    if (selDesktop) selDesktop.addEventListener('change', (e) => apply(e.target.value));
    if (selMobile) selMobile.addEventListener('change', (e) => apply(e.target.value));
  })();

  (function() {
    const resultsEl = document.getElementById('results');
    const discoveryEl = document.getElementById('contextual-discovery');

    if (!resultsEl || !discoveryEl) return;

    const observer = new MutationObserver((mutations) => {
      for (const mutation of mutations) {
        if (mutation.addedNodes.length > 0) {
          discoveryEl.classList.remove('hidden');
          break;
        }
      }
    });

    observer.observe(resultsEl, { childList: true });
  })();
</script>
