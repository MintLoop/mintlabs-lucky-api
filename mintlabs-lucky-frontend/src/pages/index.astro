---
import "../styles/global.css"; // bundle Tailwind + your theme tokens

import SiteHeader from "../components/SiteHeader.astro";
import TrackLink from "../components/TrackLink.astro";
import ThemeToolbar from "../components/ThemeToolBar.astro";
import GeneratorForm from "../components/GeneratorForm.astro";
import EduGrid from "../components/EduGrid.astro";
import NewsletterModal from "../components/NewsletterModal.astro";
import GameFacts from "../components/GameFacts.astro";
import TermsModal from "../components/TermsModal.astro";
import PrivacyModal from "../components/PrivacyModal.astro";
// env + API
const API = import.meta.env.PUBLIC_API_BASE || 'http://localhost:8000';
const ADS = import.meta.env.PUBLIC_ADSENSE_CLIENT;
const IS_PROD = import.meta.env.PROD;

const gamesEndpoint = API ? `${String(API).replace(/\/$/, '')}/games` : '/games';
const games = await fetch(gamesEndpoint).then(r => r.json()).catch(() => []);
const jsonGames = Array.isArray(games) ? JSON.stringify(games).replaceAll('`', '\\`') : '[]';
const current = Array.isArray(games) && games.length > 0 ? games[0] : null;
const apiBase = API ? String(API).replace(/\/$/, '') : '';
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" sizes="32x32" href="/clover.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/clover.png" />
    <meta name="theme-color" content="#0f766e" />
    <title>MintLabs Lucky Numbers</title>

    <!-- apply saved theme before paint -->
    <script is:inline>
      document.documentElement.setAttribute(
        'data-theme',
        localStorage.getItem('selectedTheme') || 'green-dark'
      );
    </script>
  </head>

  <body class="min-h-screen theme-bg-primary theme-text-primary">
    {jsonGames && jsonGames !== '[]' && (
      <script type="application/json" id="initial-games">{jsonGames}</script>
    )}
    <main class="mx-auto max-w-xl sm:max-w-2xl p-6 space-y-6">
      <SiteHeader />

      <!-- selector lives above the card; transparency preserved -->
      <ThemeToolbar />

      <!-- form component: markup unchanged; gets games from API -->
      <GeneratorForm games={Array.isArray(games) ? games : []} />

      <!-- Lucky Profile Feature (moved down the page) - kept same id/anchor semantics when needed -->

      <section id="results" class="space-y-3"></section>

      <div id="facts" class="mt-3">
        {current && <GameFacts game={current} />}
      </div>

      <!-- quick tools carousel moved below results for better UX flow -->
      <section id="tools-quick" class="mt-6">
        <h3 class="text-lg font-semibold mb-2">Explore our tools</h3>
        <div class="tools-carousel" aria-label="Featured tools carousel">
          <div class="carousel-track" role="list" id="carousel-track">
            <!-- Core tools (stable ordering) -->
            <TrackLink class="tool-card" href="/tools/probability-visualizer" event="carousel_click" props={{ tool: 'probability-visualizer' }}>ğŸ“‰ Probability Visualizer</TrackLink>
            <TrackLink class="tool-card" href="/tools/ticket-beautifier" event="carousel_click" props={{ tool: 'ticket-beautifier' }}>âœ¨ Ticket Beautifier</TrackLink>
            <TrackLink class="tool-card" href="/tools/quick-draw-simulator" event="carousel_click" props={{ tool: 'quick-draw-simulator' }}>ğŸ² Quick Draw Simulator</TrackLink>
            <TrackLink class="tool-card" href="/tools/combination-calculator" event="carousel_click" props={{ tool: 'combination-calculator' }}>ğŸ”¢ Combination Calculator</TrackLink>
            <!-- Placeholder slots that will be filled by session-randomized secondary tools (client-side) -->
            <div id="random-slot-1" class="tool-card tool-placeholder" role="listitem" aria-hidden="true">ğŸ”„ Loadingâ€¦</div>
            <div id="random-slot-2" class="tool-card tool-placeholder" role="listitem" aria-hidden="true">ğŸ”„ Loadingâ€¦</div>
            <!-- duplicate set for smooth looping -->
            <TrackLink class="tool-card" href="/tools/combination-calculator" event="carousel_click" props={{ tool: 'combination-calculator' }}>ğŸ”¢ Combination Calculator</TrackLink>
            <TrackLink class="tool-card" href="/tools/expected-value-calculator" event="carousel_click" props={{ tool: 'expected-value-calculator' }}>ğŸ§® Expected Value Calculator</TrackLink>
            <TrackLink class="tool-card" href="/tools/most-drawn-numbers" event="carousel_click" props={{ tool: 'most-drawn-numbers' }}>ğŸ”¥ Top 10 Most Drawn</TrackLink>
            <TrackLink class="tool-card" href="/tools/least-drawn-numbers" event="carousel_click" props={{ tool: 'least-drawn-numbers' }}>â„ï¸ Top 10 Least Drawn</TrackLink>
            <TrackLink class="tool-card" href="/tools/why-odds-dont-change" event="carousel_click" props={{ tool: 'why-odds-dont-change' }}>ğŸ² Why Odds Don't Change</TrackLink>
            <TrackLink class="tool-card" href="/tools/quick-draw-simulator" event="carousel_click" props={{ tool: 'quick-draw-simulator' }}>ğŸ² Quick Draw Simulator</TrackLink>
            <TrackLink class="tool-card" href="/tools/lottery-math-quiz" event="carousel_click" props={{ tool: 'lottery-math-quiz' }}>ğŸ§  Lottery Math Quiz</TrackLink>
            <TrackLink class="tool-card" href="/tools/ticket-beautifier" event="carousel_click" props={{ tool: 'ticket-beautifier' }}>âœ¨ Ticket Beautifier</TrackLink>
            <TrackLink class="tool-card" href="/tools/probability-visualizer" event="carousel_click" props={{ tool: 'probability-visualizer' }}>ğŸ“‰ Probability Visualizer</TrackLink>
            <TrackLink class="tool-card" href="/tools/annuity-breakdown" event="carousel_click" props={{ tool: 'annuity-breakdown' }}>ğŸ“† Annuity Visualizer</TrackLink>
            <TrackLink class="tool-card" href="/tools/number-trend-graph" event="carousel_click" props={{ tool: 'number-trend-graph' }}>ğŸ“ˆ Number Trend Graph</TrackLink>
            <TrackLink class="tool-card" href="/tools/ticket-variance" event="carousel_click" props={{ tool: 'ticket-variance' }}>ğŸ“ˆ Ticket Variance</TrackLink>
          </div>
        </div>
      </section>

      {IS_PROD && ADS && (
        <>
          <script async src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${ADS}`} crossorigin="anonymous"></script>
          <ins class="adsbygoogle block h-[90px]" data-ad-client={ADS} data-ad-slot="0000000001" data-full-width-responsive="true"></ins>
          <script is:inline>try{(window.adsbygoogle=window.adsbygoogle||[]).push({});}catch(e){console.warn('AdSense failed:',e);}</script>
        </>
      )}

      <!-- core tools now appear earlier; place Lucky Profile lower in the page as a deeper feature -->
        <section id="lucky-profile-feature" class="card-elevated mt-8">
        <div class="flex gap-4 items-start">
          <div class="text-4xl">âœ¨</div>
          <div class="flex-1 space-y-3">
            <h3 class="text-xl font-semibold readable-text">âœ¨ Lucky Profile Generator</h3>
            <p class="theme-text-secondary">
              Discover your personalized lucky numbers based on birthstone, Indian zodiac (Rashi), and color psychology.
            </p>
            <a href="/lucky-profile" class="inline-block px-6 py-3 theme-accent-primary theme-accent-hover readable-text font-semibold rounded-lg transition-colors mt-2">
              Create Your Lucky Profile â†’
            </a>
          </div>
        </div>
      </section>

      <!-- Casino-Lite Feature Card -->
      <section class="card-elevated mt-8">
        <div class="flex gap-4 items-start">
          <div class="text-4xl">ğŸ°</div>
          <div class="flex-1 space-y-3">
            <h3 class="text-xl font-semibold readable-text">ğŸ° Casino-Lite Simulators</h3>
            <p class="theme-text-secondary">
              Learn probability, card strategy, and expected value through our fictional casino games and RNG tools. Entertainment onlyâ€”no real money, no predictions, zero risk.
            </p>
            <div class="flex flex-wrap gap-2 text-sm theme-text-muted">
              <span class="px-3 py-1 rounded-full" style="background: var(--surface-elevated); border: 1px solid var(--border-primary);">
                ğŸƒ Blackjack
              </span>
              <span class="px-3 py-1 rounded-full" style="background: var(--surface-elevated); border: 1px solid var(--border-primary);">
                ğŸ¡ Wheel Spinner
              </span>
              <span class="px-3 py-1 rounded-full" style="background: var(--surface-elevated); border: 1px solid var(--border-primary);">
                ğŸ« Raffle Picker
              </span>
              <span class="px-3 py-1 rounded-full" style="background: var(--surface-elevated); border: 1px solid var(--border-primary);">
                ğŸ² Dice & More
              </span>
            </div>
            <a href="/casino-lite" class="inline-block px-6 py-3 theme-accent-primary theme-accent-hover readable-text font-semibold rounded-lg transition-colors mt-2">
              Explore Casino-Lite Hub â†’
            </a>
          </div>
        </div>
      </section>

      <EduGrid />

      <style is:inline>
        .tools-carousel { overflow: hidden; border-radius: 12px; border:1px solid rgba(255,255,255,0.04); background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005)); }
        .carousel-track { display:flex; gap:1rem; padding:0.75rem; align-items:center; animation: scroll-left 20s linear infinite; }
        .tool-card { display:inline-block; padding:var(--card-padding,0.6rem 1rem); border-radius:var(--card-radius,8px); background:var(--surface-elevated); color:var(--text-primary); text-decoration:none; font-weight:600; border:1px solid var(--border-primary-darker); white-space:nowrap; box-shadow: var(--card-shadow); }
        .tool-card:hover { background: var(--surface-hover); }
        .tool-placeholder { opacity: .6; font-weight: 600; }
        .tools-carousel:hover .carousel-track { animation-play-state: paused; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
      </style>

      <script is:inline>
        // session-stable random picks for carousel secondary slots
        (function(){
          try {
            const pool = [
              {href:'/tools/expected-value-calculator', label:'ğŸ§® Expected Value Calculator'},
              {href:'/tools/most-drawn-numbers', label:'ğŸ”¥ Most Drawn'},
              {href:'/tools/least-drawn-numbers', label:'â„ï¸ Least Drawn'},
              {href:'/tools/number-trend-graph', label:'ğŸ“ˆ Number Trend'},
              {href:'/tools/lottery-math-quiz', label:'ğŸ§  Math Quiz'},
              {href:'/tools/pattern-analyzer', label:'ğŸ” Pattern Analyzer'},
              {href:'/tools/ticket-variance', label:'ğŸ“Š Ticket Variance'},
            ];

            const getSessionPick = (key, count) => {
              try {
                const existing = window.sessionStorage.getItem(key);
                if (existing) return JSON.parse(existing);
                const picks = [];
                const copy = [...pool];
                for (let i=0;i<count;i++){
                  if (!copy.length) break;
                  const idx = Math.floor(Math.random()*copy.length);
                  picks.push(copy.splice(idx,1)[0]);
                }
                window.sessionStorage.setItem(key, JSON.stringify(picks));
                return picks;
              } catch(e) { return []; }
            };

            const picks = getSessionPick('carousel_secondary', 2);
            const slot1 = document.getElementById('random-slot-1');
            const slot2 = document.getElementById('random-slot-2');
            const makeNode = (o) => {
              const a = document.createElement('a');
              a.className = 'tool-card';
              a.href = o.href;
              a.textContent = o.label;
              a.setAttribute('role','listitem');
              return a;
            };
            if (slot1 && picks[0]) slot1.replaceWith(makeNode(picks[0]));
            if (slot2 && picks[1]) slot2.replaceWith(makeNode(picks[1]));
          } catch(e){console.warn('carousel session picks failed', e)}
        })();
      </script>

      <footer class="mt-12 pb-8 border-t border-slate-700/50 pt-8">
        {/* Footer Navigation */}
        <div class="grid gap-6 grid-cols-2 md:grid-cols-3 mb-6 text-sm">
          <div>
            <h4 class="font-semibold theme-text-secondary mb-2">Education</h4>
            <ul class="space-y-1.5 theme-text-muted">
              <li><a href="/lottery-odds" class="hover:text-emerald-400 transition-colors">Lottery Odds</a></li>
              <li><a href="/lottery-math" class="hover:text-emerald-400 transition-colors">The Math</a></li>
              <li><a href="/faq" class="hover:text-emerald-400 transition-colors">FAQ</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold theme-text-secondary mb-2">Tools</h4>
            <ul class="space-y-1.5 theme-text-muted">
              <li><a href="/tools/payout-calculator" class="hover:text-emerald-400 transition-colors">Payout Calculator</a></li>
              <li><a href="/tools/lottery-budget" class="hover:text-emerald-400 transition-colors">Budget Planner</a></li>
              <li><a href="/archive" class="hover:text-emerald-400 transition-colors">Past Results</a></li>
            </ul>
          </div>
          <div class="col-span-2 md:col-span-1">
            <h4 class="font-semibold theme-text-secondary mb-2">Legal</h4>
            <ul class="space-y-1.5 theme-text-muted">
              <li><a href="/terms" class="hover:text-emerald-400 transition-colors">Terms & Conditions</a></li>
              <li><a href="/privacy" class="hover:text-emerald-400 transition-colors">Privacy Policy</a></li>
            </ul>
          </div>
        </div>
        
        {/* Copyright */}
        <div class="text-center text-sm theme-text-muted border-t border-slate-700/50 pt-4">
          <p>Â© 2025 MintLabs. All rights reserved.</p>
          <div class="mt-2 flex items-center justify-center gap-2 text-xs theme-text-muted">
            <img src="/mintlab.png" alt="MintLabs" class="w-4 h-4 opacity-70" />
            <span>Powered by MintLabs</span>
          </div>
          <p class="mt-2 text-xs theme-text-muted max-w-sm mx-auto">
            For entertainment and education only. We do not predict lottery numbers. Play responsibly.
          </p>
        </div>
      </footer>

      {IS_PROD && ADS && (
        <>
          <script async src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${ADS}`} crossorigin="anonymous"></script>
          <ins class="adsbygoogle block h-[90px]" data-ad-client={ADS} data-ad-slot="0000000002" data-full-width-responsive="true"></ins>
          <script is:inline>try{(window.adsbygoogle=window.adsbygoogle||[]).push({});}catch(e){console.warn('AdSense failed:',e);}</script>
        </>
      )}
    </main>

    <TermsModal />
    <PrivacyModal />
    <NewsletterModal />
    

    <!-- your generator logic -->
    <script is:inline>
      window.__LUCKY_API_BASE = "http://localhost:8000";
    </script>
    <script type="module" src="/scripts/entry.js"></script>

  </body>
</html>
