---
import InfoLayout from "../../components/InfoLayout.astro";
import TrackLink from "../../components/TrackLink.astro";
import '../../styles/hub.css';

const title = "Raffle Picker | Random Name Selector";
const description = "Pick random winners from a list of names or items. Perfect for raffles, giveaways, team selection, and fair random draws.";
---

<InfoLayout title={title} description={description}>
  <div class="tool-container">
    <header class="tool-header">
      <h1>ğŸŸï¸ Raffle Picker</h1>
      <p class="tool-tagline">Fair and transparent random selection</p>
    </header>

    <div class="tool-controls">
      <div class="control-section">
        <h3>ğŸ“ Enter Participants</h3>
        <p class="hint">One name per line. Duplicates will be kept (for weighted raffles).</p>
        <textarea
          id="participantInput"
          placeholder="Alice&#10;Bob&#10;Charlie&#10;Diana&#10;Eve"
          rows="12"
        ></textarea>
        <div class="input-stats">
          <span id="participantCount">0 participants</span>
        </div>
      </div>

      <div class="control-section">
        <label for="winnerCount">Number of Winners to Pick:</label>
        <input type="number" id="winnerCount" min="1" max="100" value="1" />
        <label class="checkbox-label">
          <input type="checkbox" id="allowDuplicates" />
          <span>Allow same winner multiple times</span>
        </label>
      </div>

      <button id="pickButton" class="action-button">
        ğŸ² PICK WINNERS
      </button>

      <div class="quick-actions">
        <button id="clearButton" class="secondary-button">Clear All</button>
        <button id="sampleButton" class="secondary-button">Load Sample Data</button>
      </div>
    </div>

    <div id="resultsContainer" class="results-container" style="display: none;">
      <h2>ğŸ† Winners</h2>
      <div id="winnersList" class="winners-list"></div>
      <div class="result-actions">
        <button id="copyButton" class="secondary-button">ğŸ“‹ Copy Results</button>
        <button id="pickAgainButton" class="secondary-button">ğŸ”„ Pick Again</button>
      </div>
    </div>

    <section class="education-section">
      <h2>ğŸ“š How It Works</h2>
      <p>
        The Raffle Picker uses <strong>cryptographically secure random number generation</strong> 
        via <code>crypto.getRandomValues()</code> to ensure perfectly fair selection. 
        This is the same technology used by security-critical applications.
      </p>
      
      <div class="feature-grid">
        <div class="feature-card">
          <h3>ğŸ¯ True Randomness</h3>
          <p>Unlike pseudo-random algorithms, crypto RNG provides unpredictable results that cannot be gamed or manipulated.</p>
        </div>
        
        <div class="feature-card">
          <h3>âš–ï¸ Equal Probability</h3>
          <p>Every participant has exactly the same chance of being selected, regardless of position in the list.</p>
        </div>
        
        <div class="feature-card">
          <h3>ğŸ”„ Duplicate Handling</h3>
          <p>Enable "allow duplicates" to pick the same winner multiple times (with replacement). Disable for unique winners only.</p>
        </div>
        
        <div class="feature-card">
          <h3>ğŸ’ª Weighted Raffles</h3>
          <p>Add a name multiple times to increase their chances. Perfect for ticket-based raffles where some participants have multiple entries.</p>
        </div>
      </div>

      <h3>Use Cases</h3>
      <ul>
        <li>ğŸ‰ Giveaways and contests</li>
        <li>ğŸ† Prize drawings and raffles</li>
        <li>ğŸ‘¥ Team or group selection</li>
        <li>ğŸ“Š Random sampling for surveys</li>
        <li>ğŸ® Tournament bracket seeding</li>
        <li>ğŸ Secret Santa assignments</li>
      </ul>
    </section>

    <section class="related-tools">
      <h3>Related Tools</h3>
      <div class="tool-links">
        <TrackLink href="/casino-lite" eventName="casino_lite_hub_link">
          ğŸ° Casino-Lite Hub
        </TrackLink>
        <TrackLink href="/tools/wheel-spinner" eventName="wheel_spinner_link">
          Wheel Spinner
        </TrackLink>
        <TrackLink href="/tools/dice-roller" eventName="dice_roller_link">
          Dice Roller
        </TrackLink>
        <TrackLink href="/tools/card-picker" eventName="card_picker_link">
          Card Picker
        </TrackLink>
        <TrackLink href="/" eventName="home_link">
          Lucky Number Generator
        </TrackLink>
      </div>
    </section>
  </div>
</InfoLayout>

<!-- styles moved to global stylesheet (raffle picker) -->


<script type="module">
  const SAMPLE_DATA = `Alice Johnson
Bob Smith
Charlie Davis
Diana Prince
Eve Anderson
Frank Miller
Grace Lee
Henry Wilson
Iris Chen
Jack Brown`;

  let participants = [];

  function updateParticipantCount() {
    const textarea = /** @type {HTMLTextAreaElement|null} */ (document.getElementById('participantInput'));
    if (!textarea) return;
    const text = String(textarea.value || '').trim();
    participants = text ? text.split('\n').map(p => p.trim()).filter(p => p) : [];
    
    const countSpan = document.getElementById('participantCount');
    if (countSpan) {
      countSpan.textContent = `${participants.length} participant${participants.length !== 1 ? 's' : ''}`;
    }

    const pickButton = document.getElementById('pickButton');
    if (pickButton) {
      pickButton.disabled = participants.length === 0;
    }
  }

  function pickWinners() {
    if (participants.length === 0) return;

    const winnerCountInput = /** @type {HTMLInputElement|null} */ (document.getElementById('winnerCount'));
    const allowDuplicatesCheckbox = /** @type {HTMLInputElement|null} */ (document.getElementById('allowDuplicates'));
    
    const winnerCount = Math.min(
      parseInt(String((winnerCountInput && winnerCountInput.value) || '1'), 10),
      (allowDuplicatesCheckbox && allowDuplicatesCheckbox.checked) ? 100 : participants.length
    );

    const winners: string[] = [];
    const availableParticipants = [...participants];

    for (let i = 0; i < winnerCount; i++) {
      const pool = allowDuplicatesCheckbox.checked ? participants : availableParticipants;
      if (pool.length === 0) break;

      // Use crypto RNG for true randomness
      const randomArray = new Uint32Array(1);
      crypto.getRandomValues(randomArray);
      const randomIndex = randomArray[0] % pool.length;
      
      winners.push(pool[randomIndex]);
      
      if (!allowDuplicatesCheckbox.checked) {
        availableParticipants.splice(randomIndex, 1);
      }
    }

    displayWinners(winners);
  }

  function displayWinners(winners) {
    const container = document.getElementById('resultsContainer');
    const winnersList = document.getElementById('winnersList');
    
    if (!container || !winnersList) return;

    winnersList.innerHTML = '';
    
    winners.forEach((winner, index) => {
      const card = document.createElement('div');
      card.className = 'winner-card';
      card.style.animationDelay = `${index * 0.1}s`;

      const rank = document.createElement('div');
      rank.className = 'winner-rank';
      rank.textContent = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `#${index + 1}`;

      const name = document.createElement('div');
      name.className = 'winner-name';
      name.textContent = winner;

      card.appendChild(rank);
      card.appendChild(name);
      winnersList.appendChild(card);
    });

    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function copyResults() {
    const winnerCards = document.querySelectorAll('.winner-name');
    const winners = Array.from(winnerCards).map(card => card.textContent).join('\n');
    
    navigator.clipboard.writeText(winners).then(() => {
      const copyButton = document.getElementById('copyButton');
      if (copyButton) {
        const originalText = copyButton.textContent;
        copyButton.textContent = 'âœ… Copied!';
        setTimeout(() => {
          copyButton.textContent = originalText;
        }, 2000);
      }
    });
  }

  function loadSampleData() {
    const textarea = document.getElementById('participantInput') as HTMLTextAreaElement;
    textarea.value = SAMPLE_DATA;
    updateParticipantCount();
  }

  function clearAll() {
    const textarea = document.getElementById('participantInput') as HTMLTextAreaElement;
    textarea.value = '';
    updateParticipantCount();
    
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer) {
      resultsContainer.style.display = 'none';
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    const textarea = document.getElementById('participantInput') as HTMLTextAreaElement;
    textarea.addEventListener('input', updateParticipantCount);

    document.getElementById('pickButton')?.addEventListener('click', pickWinners);
    document.getElementById('copyButton')?.addEventListener('click', copyResults);
    document.getElementById('pickAgainButton')?.addEventListener('click', pickWinners);
    document.getElementById('sampleButton')?.addEventListener('click', loadSampleData);
    document.getElementById('clearButton')?.addEventListener('click', clearAll);

    updateParticipantCount();
  });
</script>
