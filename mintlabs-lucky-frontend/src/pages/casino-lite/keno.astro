---
/**
 * Keno - Casino-Lite Number Matching Game
 * Pick 10 numbers from 80, watch the draw, win CatnipCoin!
 */
import CasinoLayout from "../../components/CasinoLayout.astro";

const title = "Keno";
const description = "Play Keno - pick your lucky numbers and see how many match! A fun number-matching game with MintyCatnipCoin rewards.";
---

<CasinoLayout title={title} description={description}>
  <!-- Bet Controls Row -->
  <div class="flex flex-wrap items-center justify-between gap-4 p-4 rounded-xl" style="background: var(--surface-elevated);">
    <div class="flex items-center gap-4">
      <label for="betSelect" class="text-sm" style="color: var(--text-secondary);">Bet:</label>
      <select
        id="betSelect"
        class="px-3 py-2 rounded-lg font-bold text-sm"
        style="background: var(--surface); color: var(--accent-primary); border: 1px solid var(--border-primary);"
      >
        <option value="5">5 CC</option>
        <option value="10">10 CC</option>
        <option value="25">25 CC</option>
        <option value="50">50 CC</option>
      </select>
      <div id="catnip-change" class="text-sm font-bold hidden"></div>
    </div>
    <div class="text-sm" style="color: var(--text-secondary);">
      Selected: <span id="selection-count" class="font-bold" style="color: var(--accent-primary);">0</span> / 10
    </div>
  </div>

  <!-- Game Area -->
  <div class="space-y-6">
    <!-- Quick Actions -->
    <div class="flex gap-2 justify-center">
      <button
        id="clear-btn"
        class="px-4 py-2 rounded-lg text-sm font-medium transition-all"
        style="background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border-primary);"
      >
        Clear All
      </button>
      <button
        id="random-btn"
        class="px-4 py-2 rounded-lg text-sm font-medium transition-all"
        style="background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border-primary);"
      >
        ðŸŽ² Random 10
      </button>
    </div>

    <!-- Number Grid (1-80) -->
    <div class="p-4 sm:p-6 rounded-xl" style="background: var(--surface-elevated);">
      <div id="keno-grid" class="grid grid-cols-8 sm:grid-cols-10 gap-1.5 sm:gap-2">
        <!-- Numbers generated by JS -->
      </div>
    </div>

    <!-- Draw Button -->
    <div class="flex justify-center">
      <button
        id="draw-btn"
        class="px-10 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
        style="background: var(--accent-primary); color: var(--text-on-accent, white);"
        disabled
      >
        Draw Numbers
      </button>
    </div>

    <!-- Results Panel (hidden initially) -->
    <div id="results-panel" class="hidden space-y-4">
      <!-- Drawn Numbers -->
      <div class="p-4 sm:p-6 rounded-xl" style="background: var(--surface-elevated);">
        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">Drawn Numbers</h3>
        <div id="drawn-numbers" class="flex flex-wrap gap-2 justify-center">
          <!-- Filled by JS -->
        </div>
      </div>

      <!-- Result Message -->
      <div id="result-message" class="p-6 rounded-xl text-center" style="background: var(--surface-elevated); border: 2px solid var(--accent-primary);">
        <div id="hit-count" class="text-4xl font-bold mb-2" style="color: var(--accent-primary);">0</div>
        <div id="hit-label" class="text-xl" style="color: var(--text-primary);">Matches</div>
        <div id="hit-message" class="mt-2 text-sm" style="color: var(--text-secondary);">--</div>
        <div id="payout-message" class="mt-3 text-lg font-bold hidden" style="color: var(--accent-success);">--</div>
      </div>

      <!-- Play Again -->
      <div class="flex justify-center gap-4">
        <button
          id="play-again-btn"
          class="px-8 py-3 rounded-lg font-bold transition-all hover:scale-105"
          style="background: var(--accent-primary); color: var(--text-on-accent, white);"
        >
          ðŸŽ² Play Again
        </button>
        <button
          id="new-picks-btn"
          class="px-8 py-3 rounded-lg font-bold transition-all"
          style="background: var(--surface); color: var(--text-primary); border: 2px solid var(--border-primary);"
        >
          New Numbers
        </button>
      </div>
    </div>
  </div>

  <!-- How to Play -->
  <div class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated);">
    <h2 class="text-2xl font-bold" style="color: var(--text-primary);">How to Play</h2>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="space-y-2">
        <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">ðŸŽ¯ Objective</h3>
        <p class="text-sm" style="color: var(--text-secondary);">
          Pick 10 numbers from 1-80. The house draws 20 numbers. The more matches, the bigger your payout!
        </p>
      </div>
      <div class="space-y-2">
        <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">ðŸ’° Payouts (10-Spot)</h3>
        <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
          <li>â€¢ 5 matches: <strong style="color: var(--accent-success);">3Ã—</strong> your bet</li>
          <li>â€¢ 6 matches: <strong style="color: var(--accent-success);">20Ã—</strong> your bet</li>
          <li>â€¢ 7 matches: <strong style="color: var(--accent-success);">100Ã—</strong> your bet</li>
          <li>â€¢ 8 matches: <strong style="color: var(--accent-success);">500Ã—</strong> your bet</li>
          <li>â€¢ 9 matches: <strong style="color: var(--accent-success);">2,000Ã—</strong> your bet</li>
          <li>â€¢ 10 matches: <strong style="color: var(--accent-success);">10,000Ã—</strong> your bet ðŸŽ‰</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Probability Facts -->
  <div class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated);">
    <h2 class="text-2xl font-bold" style="color: var(--text-primary);">ðŸŽ² Keno Probability</h2>
    <div class="grid sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
      <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-2xl font-bold" style="color: var(--accent-primary);">25%</div>
        <div class="text-xs mt-1" style="color: var(--text-secondary);">Expected match rate</div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-2xl font-bold" style="color: var(--accent-primary);">1 in 9M</div>
        <div class="text-xs mt-1" style="color: var(--text-secondary);">Odds of 10/10 match</div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-2xl font-bold" style="color: var(--accent-primary);">~5%</div>
        <div class="text-xs mt-1" style="color: var(--text-secondary);">Chance of 5+ hits</div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-2xl font-bold" style="color: var(--accent-primary);">~27%</div>
        <div class="text-xs mt-1" style="color: var(--text-secondary);">House edge</div>
      </div>
    </div>
    <p class="text-xs text-center" style="color: var(--text-muted);">
      Keno has a high house edge compared to other casino games. Play for fun, not profit!
    </p>
  </div>

  <!-- Learn Section (Collapsible) -->
  <details class="rounded-xl" style="background: var(--surface-elevated);">
    <summary class="p-4 cursor-pointer font-semibold text-sm" style="color: var(--text-primary);">
      ðŸ“Š Full Probability Table
    </summary>
    <div class="p-4 pt-0 space-y-4">
      <p class="text-sm" style="color: var(--text-secondary);">
        In Keno, you pick 10 numbers from 80, and 20 are drawn. The more matches, the rarer the outcome!
      </p>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" style="color: var(--text-secondary);">
          <thead>
            <tr style="border-bottom: 1px solid var(--border-primary);">
              <th class="text-left py-2 px-2">Matches</th>
              <th class="text-right py-2 px-2">Probability</th>
              <th class="text-right py-2 px-2">Odds</th>
              <th class="text-right py-2 px-2">Payout</th>
            </tr>
          </thead>
          <tbody id="probability-table">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
      <details class="text-sm" style="color: var(--text-muted);">
        <summary class="cursor-pointer" style="color: var(--text-secondary);">Show Formula</summary>
        <div class="mt-2 p-3 rounded-lg font-mono text-xs" style="background: var(--surface); border: 1px solid var(--border-primary);">
          P(h matches) = C(20,h) Ã— C(60,k-h) / C(80,k)<br>
          where k = 10 (picks), h = hits
        </div>
      </details>
    </div>
  </details>

  <!-- Fairness & RNG Disclosure -->
  <details class="rounded-xl" style="background: var(--surface-elevated);">
    <summary class="p-4 cursor-pointer font-semibold text-sm" style="color: var(--text-primary);">
      ðŸŽ² Fairness & RNG
    </summary>
    <div class="p-4 pt-0 space-y-2 text-xs" style="color: var(--text-secondary);">
      <p>
        <strong style="color: var(--text-primary);">Random Number Generation:</strong>
        All draws use the Web Crypto API (<code style="background: var(--surface); padding: 2px 6px; border-radius: 4px;">crypto.getRandomValues()</code>),
        providing cryptographically secure randomness.
      </p>
      <p>
        Each draw selects 20 unique numbers from 1-80 with uniform probability.
        No number can appear twice in a single draw.
      </p>
      <p style="color: var(--text-muted);">
        This is for entertainment and education only. No real money is involved.
        MintyCatnipCoin (MCC) is a fictional currency with no value.
      </p>
    </div>
  </details>
</CasinoLayout>

<style is:global>
  .keno-number {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.75rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s ease;
    user-select: none;
    background: var(--surface);
    color: var(--text-primary);
    border: 2px solid var(--border-primary);
  }

  @media (min-width: 640px) {
    .keno-number {
      font-size: 0.875rem;
      border-radius: 0.5rem;
    }
  }

  .keno-number:hover:not(.disabled) {
    border-color: var(--accent-primary);
    transform: scale(1.05);
  }

  .keno-number.selected {
    background: var(--accent-primary);
    color: var(--text-on-accent, white);
    border-color: var(--accent-primary);
  }

  .keno-number.drawn {
    background: var(--accent-warning, #f59e0b);
    color: white;
    border-color: var(--accent-warning, #f59e0b);
  }

  .keno-number.hit {
    background: var(--accent-success, #22c55e);
    color: white;
    border-color: var(--accent-success, #22c55e);
    animation: pulse-hit 0.5s ease-out;
  }

  .keno-number.miss {
    opacity: 0.5;
  }

  .keno-number.disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }

  .drawn-ball {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    border-radius: 50%;
    background: var(--surface);
    color: var(--text-primary);
    border: 2px solid var(--border-primary);
  }

  .drawn-ball.hit {
    background: var(--accent-success, #22c55e);
    color: white;
    border-color: var(--accent-success, #22c55e);
  }

  @keyframes pulse-hit {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }
</style>

<script>
  import {
    KENO_MAX,
    KENO_PICKS,
    playKeno,
    getProbabilityTable,
    getClassificationColor
  } from '../../scripts/casino/keno';
  import {
    getCatnipBalance,
    addCatnip,
    subtractCatnip
  } from '../../utils/catnipCoin';

  type GameState = 'picking' | 'drawing' | 'resolved';

  // Payout table for 10-spot Keno
  const PAYOUTS: Record<number, number> = {
    0: 0,
    1: 0,
    2: 0,
    3: 0,
    4: 0,
    5: 3,      // 3x bet
    6: 20,     // 20x bet
    7: 100,    // 100x bet
    8: 500,    // 500x bet
    9: 2000,   // 2000x bet
    10: 10000  // 10000x bet (jackpot!)
  };

  let state: GameState = 'picking';
  let selectedNumbers: Set<number> = new Set();
  let lastResult: ReturnType<typeof playKeno> | null = null;
  let baseBet = 5;

  // DOM elements
  const grid = document.getElementById('keno-grid')!;
  const selectionCount = document.getElementById('selection-count')!;
  const clearBtn = document.getElementById('clear-btn')!;
  const randomBtn = document.getElementById('random-btn')!;
  const drawBtn = document.getElementById('draw-btn') as HTMLButtonElement;
  const betSelect = document.getElementById('betSelect') as HTMLSelectElement;
  const resultsPanel = document.getElementById('results-panel')!;
  const drawnNumbers = document.getElementById('drawn-numbers')!;
  const hitCount = document.getElementById('hit-count')!;
  const hitLabel = document.getElementById('hit-label')!;
  const hitMessage = document.getElementById('hit-message')!;
  const payoutMessage = document.getElementById('payout-message')!;
  const playAgainBtn = document.getElementById('play-again-btn')!;
  const newPicksBtn = document.getElementById('new-picks-btn')!;
  const probabilityTable = document.getElementById('probability-table')!;
  const catnipChangeEl = document.getElementById('catnip-change')!;

  // Update CatnipCoin balance display (in header via CasinoLayout)
  function updateBalanceDisplay() {
    const balance = getCatnipBalance();
    const balanceEl = document.getElementById('header-balance-value');
    if (balanceEl) {
      balanceEl.textContent = balance.toLocaleString();
    }
  }

  // Show CatnipCoin change animation
  function showCatnipChange(amount: number, reason: string) {
    const sign = amount > 0 ? '+' : '';
    catnipChangeEl.textContent = `${sign}${amount} CC (${reason})`;
    catnipChangeEl.style.color = amount > 0 ? 'var(--accent-success)' : 'var(--accent-warning)';
    catnipChangeEl.classList.remove('hidden');
    setTimeout(() => {
      catnipChangeEl.classList.add('hidden');
    }, 3000);
  }

  // Listen for balance changes
  window.addEventListener('catnipBalanceChange', updateBalanceDisplay as EventListener);

  // Initialize grid
  function initGrid() {
    grid.innerHTML = '';
    for (let i = 1; i <= KENO_MAX; i++) {
      const cell = document.createElement('div');
      cell.className = 'keno-number';
      cell.textContent = String(i);
      cell.dataset.number = String(i);
      cell.addEventListener('click', () => toggleNumber(i));
      grid.appendChild(cell);
    }
  }

  // Initialize probability table with payouts
  function initProbabilityTable() {
    const probs = getProbabilityTable();
    probabilityTable.innerHTML = probs.map(p => `
      <tr style="border-bottom: 1px solid var(--border-primary);">
        <td class="py-2 px-2">${p.hits}</td>
        <td class="text-right py-2 px-2">${(p.probability * 100).toFixed(4)}%</td>
        <td class="text-right py-2 px-2">${p.odds}</td>
        <td class="text-right py-2 px-2 font-bold" style="color: ${PAYOUTS[p.hits] > 0 ? 'var(--accent-success)' : 'var(--text-muted)'};">
          ${PAYOUTS[p.hits] > 0 ? PAYOUTS[p.hits] + 'Ã—' : '-'}
        </td>
      </tr>
    `).join('');
  }

  // Toggle number selection
  function toggleNumber(num: number) {
    if (state !== 'picking') return;

    const cell = grid.querySelector(`[data-number="${num}"]`);
    if (!cell) return;

    if (selectedNumbers.has(num)) {
      selectedNumbers.delete(num);
      cell.classList.remove('selected');
    } else if (selectedNumbers.size < KENO_PICKS) {
      selectedNumbers.add(num);
      cell.classList.add('selected');
    }

    updateUI();
  }

  // Update UI state
  function updateUI() {
    selectionCount.textContent = String(selectedNumbers.size);

    // Check if can afford bet
    baseBet = parseInt(betSelect?.value || '5', 10);
    const canAfford = getCatnipBalance() >= baseBet;

    drawBtn.disabled = selectedNumbers.size !== KENO_PICKS || state !== 'picking' || !canAfford;

    // Update button text based on state
    if (state === 'picking') {
      if (!canAfford) {
        drawBtn.textContent = 'Not Enough CC';
      } else if (selectedNumbers.size === KENO_PICKS) {
        drawBtn.textContent = `Draw Numbers (${baseBet} CC)`;
      } else {
        drawBtn.textContent = `Select ${KENO_PICKS - selectedNumbers.size} more`;
      }
    }
  }

  // Clear all selections
  function clearSelections() {
    selectedNumbers.clear();
    grid.querySelectorAll('.keno-number').forEach(cell => {
      cell.classList.remove('selected', 'hit', 'miss', 'drawn', 'disabled');
    });
    updateUI();
  }

  // Select random numbers
  function selectRandom() {
    clearSelections();
    const available = Array.from({ length: KENO_MAX }, (_, i) => i + 1);

    // Fisher-Yates partial shuffle
    for (let i = 0; i < KENO_PICKS; i++) {
      const j = i + Math.floor(Math.random() * (available.length - i));
      [available[i], available[j]] = [available[j], available[i]];
      toggleNumber(available[i]);
    }
  }

  // Draw numbers and show results
  function draw() {
    if (selectedNumbers.size !== KENO_PICKS) return;

    // Get bet value
    baseBet = parseInt(betSelect?.value || '5', 10);

    // Check balance
    if (getCatnipBalance() < baseBet) {
      showCatnipChange(0, 'Not enough CC!');
      return;
    }

    // Deduct bet
    subtractCatnip(baseBet, 'Keno bet');
    showCatnipChange(-baseBet, 'Bet');

    // Disable bet selector during game
    if (betSelect) betSelect.disabled = true;

    state = 'drawing';
    drawBtn.disabled = true;

    // Get seed from URL if in debug mode
    const urlParams = new URLSearchParams(window.location.search);
    const seed = urlParams.get('seed') ? parseInt(urlParams.get('seed')!, 10) : undefined;

    // Play the game
    const picks = Array.from(selectedNumbers);
    lastResult = playKeno(picks, seed);

    // Animate the draw
    animateDraw(lastResult);
  }

  // Animate the draw sequence
  function animateDraw(result: ReturnType<typeof playKeno>) {
    const drawSet = new Set(result.draw);
    const hitSet = new Set(result.hits);

    // Disable grid during animation
    grid.querySelectorAll('.keno-number').forEach(cell => {
      cell.classList.add('disabled');
    });

    // Show results panel
    resultsPanel.classList.remove('hidden');
    drawnNumbers.innerHTML = '';
    payoutMessage.classList.add('hidden');

    // Animate each drawn number
    let delay = 0;
    const animationDelay = 80; // ms per number (faster for 20 numbers)

    result.draw.forEach((num, index) => {
      setTimeout(() => {
        // Add to drawn numbers display
        const ball = document.createElement('div');
        ball.className = 'drawn-ball';
        if (hitSet.has(num)) {
          ball.classList.add('hit');
        }
        ball.textContent = String(num);
        drawnNumbers.appendChild(ball);

        // Highlight on grid
        const gridCell = grid.querySelector(`[data-number="${num}"]`);
        if (gridCell) {
          if (hitSet.has(num)) {
            gridCell.classList.add('hit');
          } else {
            gridCell.classList.add('drawn');
          }
        }

        // On last number, show final results
        if (index === result.draw.length - 1) {
          finalizeDraw(result);
        }
      }, delay);

      delay += animationDelay;
    });
  }

  // Finalize draw and show results
  function finalizeDraw(result: ReturnType<typeof playKeno>) {
    state = 'resolved';

    // Mark misses
    selectedNumbers.forEach(num => {
      if (!result.hits.includes(num)) {
        const cell = grid.querySelector(`[data-number="${num}"]`);
        if (cell) cell.classList.add('miss');
      }
    });

    // Update result display
    hitCount.textContent = String(result.hitCount);
    hitCount.style.color = getClassificationColor(result.classification);
    hitLabel.textContent = result.hitCount === 1 ? 'Match' : 'Matches';
    hitMessage.textContent = result.message;

    // Style result message based on classification
    const resultMsg = document.getElementById('result-message')!;
    resultMsg.style.borderColor = getClassificationColor(result.classification);

    // Calculate and show payout
    const multiplier = PAYOUTS[result.hitCount] || 0;
    if (multiplier > 0) {
      const payout = baseBet * multiplier;
      addCatnip(payout, `Keno ${result.hitCount} matches`);
      showCatnipChange(payout, `${result.hitCount} Matches!`);
      payoutMessage.textContent = `+${payout.toLocaleString()} CC (${multiplier}Ã— win!)`;
      payoutMessage.classList.remove('hidden');
    } else {
      payoutMessage.textContent = 'No payout - try again!';
      payoutMessage.style.color = 'var(--text-muted)';
      payoutMessage.classList.remove('hidden');
    }

    // Re-enable bet selector
    if (betSelect) betSelect.disabled = false;
  }

  // Play again with same numbers
  function playAgain() {
    if (!lastResult) return;

    // Reset grid visuals but keep selections
    grid.querySelectorAll('.keno-number').forEach(cell => {
      cell.classList.remove('hit', 'miss', 'drawn', 'disabled');
      const num = parseInt(cell.getAttribute('data-number') || '0', 10);
      if (selectedNumbers.has(num)) {
        cell.classList.add('selected');
      }
    });

    // Hide results
    resultsPanel.classList.add('hidden');
    drawnNumbers.innerHTML = '';

    // Reset state
    state = 'picking';
    updateUI();
  }

  // Reset with new number picks
  function newPicks() {
    clearSelections();
    resultsPanel.classList.add('hidden');
    drawnNumbers.innerHTML = '';
    state = 'picking';
    updateUI();
  }

  // Event listeners
  clearBtn.addEventListener('click', () => {
    if (state === 'picking') {
      clearSelections();
    }
  });

  randomBtn.addEventListener('click', () => {
    if (state === 'picking') {
      selectRandom();
    }
  });

  betSelect.addEventListener('change', updateUI);
  drawBtn.addEventListener('click', draw);
  playAgainBtn.addEventListener('click', playAgain);
  newPicksBtn.addEventListener('click', newPicks);

  // Initialize
  initGrid();
  initProbabilityTable();
  updateBalanceDisplay();
  updateUI();
</script>
