---
/**
 * Keno - Casino-Lite Number Matching Game
 * A fun, educational game with no money semantics
 */
import InfoLayout from "../../components/InfoLayout.astro";

const title = "Keno";
const description = "Play Keno - pick your lucky numbers and see how many match! A fun number-matching game for entertainment and learning about probability.";
---

<InfoLayout
  title={title}
  subtitle="Pick 10 numbers from 1-80, then watch the draw!"
  pageTitle="Keno - Lucky Number Matching Game | Casino-Lite"
  description={description}
>
  <div slot="teaser">
    <strong style="color: var(--accent-primary);">How to play:</strong>
    Select 10 numbers from the grid below, then hit "Draw Numbers" to see how many you matched!
  </div>

  <!-- Game Area -->
  <div class="space-y-6">
    <!-- Selection Counter -->
    <div class="flex items-center justify-between p-4 rounded-xl" style="background: var(--surface-elevated, rgba(30,41,59,0.6)); border: 1px solid var(--border-primary);">
      <div class="text-sm" style="color: var(--text-secondary);">
        Selected: <span id="selection-count" class="font-bold" style="color: var(--accent-primary);">0</span> / 10
      </div>
      <div class="flex gap-2">
        <button
          id="clear-btn"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all"
          style="background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border-primary);"
        >
          Clear All
        </button>
        <button
          id="random-btn"
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all"
          style="background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border-primary);"
        >
          Random 10
        </button>
      </div>
    </div>

    <!-- Number Grid (1-80) -->
    <div class="p-6 rounded-xl" style="background: var(--surface-elevated, rgba(30,41,59,0.6)); border: 1px solid var(--border-primary);">
      <div id="keno-grid" class="grid grid-cols-10 gap-2 sm:gap-3">
        <!-- Numbers generated by JS -->
      </div>
    </div>

    <!-- Draw Button -->
    <div class="flex justify-center">
      <button
        id="draw-btn"
        class="px-10 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
        style="background: var(--accent-primary); color: var(--text-on-accent, white);"
        disabled
      >
        Draw Numbers
      </button>
    </div>

    <!-- Results Panel (hidden initially) -->
    <div id="results-panel" class="hidden space-y-4">
      <!-- Drawn Numbers -->
      <div class="p-6 rounded-xl" style="background: var(--surface-elevated, rgba(30,41,59,0.6)); border: 1px solid var(--border-primary);">
        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">Drawn Numbers</h3>
        <div id="drawn-numbers" class="flex flex-wrap gap-2 justify-center">
          <!-- Filled by JS -->
        </div>
      </div>

      <!-- Result Message -->
      <div id="result-message" class="p-6 rounded-xl text-center" style="background: var(--surface-elevated, rgba(30,41,59,0.6)); border: 2px solid var(--accent-primary);">
        <div id="hit-count" class="text-4xl font-bold mb-2" style="color: var(--accent-primary);">0</div>
        <div id="hit-label" class="text-xl" style="color: var(--text-primary);">Matches</div>
        <div id="hit-message" class="mt-2 text-sm" style="color: var(--text-secondary);">--</div>
      </div>

      <!-- Play Again -->
      <div class="flex justify-center gap-4">
        <button
          id="play-again-btn"
          class="px-8 py-3 rounded-lg font-bold transition-all hover:scale-105"
          style="background: var(--accent-primary); color: var(--text-on-accent, white);"
        >
          Play Again
        </button>
        <button
          id="new-picks-btn"
          class="px-8 py-3 rounded-lg font-bold transition-all"
          style="background: var(--surface); color: var(--text-primary); border: 2px solid var(--border-primary);"
        >
          New Numbers
        </button>
      </div>
    </div>

    <!-- Learn Section (Collapsible) -->
    <details class="rounded-xl" style="background: var(--surface-elevated, rgba(30,41,59,0.6)); border: 1px solid var(--border-primary);">
      <summary class="p-4 cursor-pointer font-semibold" style="color: var(--text-primary);">
        Learn About Keno Odds
      </summary>
      <div class="p-4 pt-0 space-y-4">
        <p class="text-sm" style="color: var(--text-secondary);">
          In Keno, you pick 10 numbers from 80, and 20 are drawn. The more matches, the rarer the outcome!
        </p>

        <!-- Probability Table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm" style="color: var(--text-secondary);">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-primary);">
                <th class="text-left py-2 px-2">Matches</th>
                <th class="text-right py-2 px-2">Probability</th>
                <th class="text-right py-2 px-2">Odds</th>
              </tr>
            </thead>
            <tbody id="probability-table">
              <!-- Filled by JS -->
            </tbody>
          </table>
        </div>

        <!-- Formula Toggle -->
        <details class="text-sm" style="color: var(--text-muted);">
          <summary class="cursor-pointer" style="color: var(--text-secondary);">Show Formula</summary>
          <div class="mt-2 p-3 rounded-lg font-mono text-xs" style="background: var(--surface); border: 1px solid var(--border-primary);">
            P(h matches) = C(20,h) Ã— C(60,k-h) / C(80,k)<br>
            where k = 10 (picks), h = hits
          </div>
        </details>

        <!-- Related Tools -->
        <div class="pt-4" style="border-top: 1px solid var(--border-primary);">
          <p class="text-sm font-medium mb-2" style="color: var(--text-secondary);">Related Tools:</p>
          <div class="flex flex-wrap gap-2">
            <a href="/tools/combination-calculator" class="text-sm px-3 py-1 rounded-full transition-colors" style="background: var(--surface); color: var(--accent-primary); border: 1px solid var(--border-primary);">
              Combination Calculator
            </a>
            <a href="/tools/probability-visualizer" class="text-sm px-3 py-1 rounded-full transition-colors" style="background: var(--surface); color: var(--accent-primary); border: 1px solid var(--border-primary);">
              Probability Visualizer
            </a>
          </div>
        </div>
      </div>
    </details>

    <!-- Fairness & RNG Disclosure -->
    <details class="rounded-xl" style="background: var(--surface-elevated, rgba(30,41,59,0.6)); border: 1px solid var(--border-primary);">
      <summary class="p-4 cursor-pointer font-semibold" style="color: var(--text-primary);">
        Fairness & RNG
      </summary>
      <div class="p-4 pt-0 space-y-2 text-sm" style="color: var(--text-secondary);">
        <p>
          <strong style="color: var(--text-primary);">Random Number Generation:</strong>
          All draws use the Web Crypto API (<code style="background: var(--surface); padding: 2px 6px; border-radius: 4px;">crypto.getRandomValues()</code>),
          providing cryptographically secure randomness.
        </p>
        <p>
          Each draw selects 20 unique numbers from 1-80 with uniform probability.
          No number can appear twice in a single draw.
        </p>
        <p style="color: var(--text-muted);">
          This is for entertainment and education only. No real money is involved.
        </p>
      </div>
    </details>
  </div>
</InfoLayout>

<style is:global>
  .keno-number {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.15s ease;
    user-select: none;
    background: var(--surface);
    color: var(--text-primary);
    border: 2px solid var(--border-primary);
  }

  .keno-number:hover:not(.disabled) {
    border-color: var(--accent-primary);
    transform: scale(1.05);
  }

  .keno-number.selected {
    background: var(--accent-primary);
    color: var(--text-on-accent, white);
    border-color: var(--accent-primary);
  }

  .keno-number.drawn {
    background: var(--accent-warning, #f59e0b);
    color: white;
    border-color: var(--accent-warning, #f59e0b);
  }

  .keno-number.hit {
    background: var(--accent-success, #22c55e);
    color: white;
    border-color: var(--accent-success, #22c55e);
    animation: pulse-hit 0.5s ease-out;
  }

  .keno-number.miss {
    opacity: 0.5;
  }

  .keno-number.disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }

  .drawn-ball {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    border-radius: 50%;
    background: var(--surface);
    color: var(--text-primary);
    border: 2px solid var(--border-primary);
  }

  .drawn-ball.hit {
    background: var(--accent-success, #22c55e);
    color: white;
    border-color: var(--accent-success, #22c55e);
  }

  @keyframes pulse-hit {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }
</style>

<script>
  import {
    KENO_MAX,
    KENO_PICKS,
    playKeno,
    getProbabilityTable,
    getClassificationColor
  } from '../../scripts/casino/keno';

  type GameState = 'picking' | 'drawing' | 'resolved';

  let state: GameState = 'picking';
  let selectedNumbers: Set<number> = new Set();
  let lastResult: ReturnType<typeof playKeno> | null = null;

  // DOM elements
  const grid = document.getElementById('keno-grid')!;
  const selectionCount = document.getElementById('selection-count')!;
  const clearBtn = document.getElementById('clear-btn')!;
  const randomBtn = document.getElementById('random-btn')!;
  const drawBtn = document.getElementById('draw-btn') as HTMLButtonElement;
  const resultsPanel = document.getElementById('results-panel')!;
  const drawnNumbers = document.getElementById('drawn-numbers')!;
  const hitCount = document.getElementById('hit-count')!;
  const hitLabel = document.getElementById('hit-label')!;
  const hitMessage = document.getElementById('hit-message')!;
  const playAgainBtn = document.getElementById('play-again-btn')!;
  const newPicksBtn = document.getElementById('new-picks-btn')!;
  const probabilityTable = document.getElementById('probability-table')!;

  // Initialize grid
  function initGrid() {
    grid.innerHTML = '';
    for (let i = 1; i <= KENO_MAX; i++) {
      const cell = document.createElement('div');
      cell.className = 'keno-number';
      cell.textContent = String(i);
      cell.dataset.number = String(i);
      cell.addEventListener('click', () => toggleNumber(i));
      grid.appendChild(cell);
    }
  }

  // Initialize probability table
  function initProbabilityTable() {
    const probs = getProbabilityTable();
    probabilityTable.innerHTML = probs.map(p => `
      <tr style="border-bottom: 1px solid var(--border-primary);">
        <td class="py-2 px-2">${p.hits}</td>
        <td class="text-right py-2 px-2">${(p.probability * 100).toFixed(4)}%</td>
        <td class="text-right py-2 px-2">${p.odds}</td>
      </tr>
    `).join('');
  }

  // Toggle number selection
  function toggleNumber(num: number) {
    if (state !== 'picking') return;

    const cell = grid.querySelector(`[data-number="${num}"]`);
    if (!cell) return;

    if (selectedNumbers.has(num)) {
      selectedNumbers.delete(num);
      cell.classList.remove('selected');
    } else if (selectedNumbers.size < KENO_PICKS) {
      selectedNumbers.add(num);
      cell.classList.add('selected');
    }

    updateUI();
  }

  // Update UI state
  function updateUI() {
    selectionCount.textContent = String(selectedNumbers.size);
    drawBtn.disabled = selectedNumbers.size !== KENO_PICKS || state !== 'picking';

    // Update button text based on state
    if (state === 'picking') {
      drawBtn.textContent = selectedNumbers.size === KENO_PICKS
        ? 'Draw Numbers'
        : `Select ${KENO_PICKS - selectedNumbers.size} more`;
    }
  }

  // Clear all selections
  function clearSelections() {
    selectedNumbers.clear();
    grid.querySelectorAll('.keno-number').forEach(cell => {
      cell.classList.remove('selected', 'hit', 'miss', 'drawn', 'disabled');
    });
    updateUI();
  }

  // Select random numbers
  function selectRandom() {
    clearSelections();
    const available = Array.from({ length: KENO_MAX }, (_, i) => i + 1);

    // Fisher-Yates partial shuffle
    for (let i = 0; i < KENO_PICKS; i++) {
      const j = i + Math.floor(Math.random() * (available.length - i));
      [available[i], available[j]] = [available[j], available[i]];
      toggleNumber(available[i]);
    }
  }

  // Draw numbers and show results
  function draw() {
    if (selectedNumbers.size !== KENO_PICKS) return;

    state = 'drawing';
    drawBtn.disabled = true;

    // Get seed from URL if in debug mode
    const urlParams = new URLSearchParams(window.location.search);
    const seed = urlParams.get('seed') ? parseInt(urlParams.get('seed')!, 10) : undefined;

    // Play the game
    const picks = Array.from(selectedNumbers);
    lastResult = playKeno(picks, seed);

    // Animate the draw
    animateDraw(lastResult);
  }

  // Animate the draw sequence
  function animateDraw(result: ReturnType<typeof playKeno>) {
    const drawSet = new Set(result.draw);
    const hitSet = new Set(result.hits);

    // Disable grid during animation
    grid.querySelectorAll('.keno-number').forEach(cell => {
      cell.classList.add('disabled');
    });

    // Show results panel
    resultsPanel.classList.remove('hidden');
    drawnNumbers.innerHTML = '';

    // Animate each drawn number
    let delay = 0;
    const animationDelay = 100; // ms per number

    result.draw.forEach((num, index) => {
      setTimeout(() => {
        // Add to drawn numbers display
        const ball = document.createElement('div');
        ball.className = 'drawn-ball';
        if (hitSet.has(num)) {
          ball.classList.add('hit');
        }
        ball.textContent = String(num);
        drawnNumbers.appendChild(ball);

        // Highlight on grid
        const gridCell = grid.querySelector(`[data-number="${num}"]`);
        if (gridCell) {
          if (hitSet.has(num)) {
            gridCell.classList.add('hit');
          } else {
            gridCell.classList.add('drawn');
          }
        }

        // On last number, show final results
        if (index === result.draw.length - 1) {
          finalizeDraw(result);
        }
      }, delay);

      delay += animationDelay;
    });
  }

  // Finalize draw and show results
  function finalizeDraw(result: ReturnType<typeof playKeno>) {
    state = 'resolved';

    // Mark misses
    selectedNumbers.forEach(num => {
      if (!result.hits.includes(num)) {
        const cell = grid.querySelector(`[data-number="${num}"]`);
        if (cell) cell.classList.add('miss');
      }
    });

    // Update result display
    hitCount.textContent = String(result.hitCount);
    hitCount.style.color = getClassificationColor(result.classification);
    hitLabel.textContent = result.hitCount === 1 ? 'Match' : 'Matches';
    hitMessage.textContent = result.message;

    // Style result message based on classification
    const resultMsg = document.getElementById('result-message')!;
    resultMsg.style.borderColor = getClassificationColor(result.classification);
  }

  // Play again with same numbers
  function playAgain() {
    if (!lastResult) return;

    // Reset grid visuals but keep selections
    grid.querySelectorAll('.keno-number').forEach(cell => {
      cell.classList.remove('hit', 'miss', 'drawn', 'disabled');
      const num = parseInt(cell.getAttribute('data-number') || '0', 10);
      if (selectedNumbers.has(num)) {
        cell.classList.add('selected');
      }
    });

    // Hide results
    resultsPanel.classList.add('hidden');
    drawnNumbers.innerHTML = '';

    // Reset state
    state = 'picking';
    updateUI();
  }

  // Reset with new number picks
  function newPicks() {
    clearSelections();
    resultsPanel.classList.add('hidden');
    drawnNumbers.innerHTML = '';
    state = 'picking';
    updateUI();
  }

  // Event listeners
  clearBtn.addEventListener('click', () => {
    if (state === 'picking') {
      clearSelections();
    }
  });

  randomBtn.addEventListener('click', () => {
    if (state === 'picking') {
      selectRandom();
    }
  });

  drawBtn.addEventListener('click', draw);
  playAgainBtn.addEventListener('click', playAgain);
  newPicksBtn.addEventListener('click', newPicks);

  // Initialize
  initGrid();
  initProbabilityTable();
  updateUI();
</script>
