---
// Blackjack - Casino-Lite Card Game
// Phase 4 - Casino-Lite Visual System + CatnipCoin Integration

import CasinoLayout from "../../components/CasinoLayout.astro";
import DeckSelector from "../../components/casino/DeckSelector.astro";
import { DECK_THEMES } from "../../config/decks";

const title = "Blackjack";
const description = "Practice blackjack strategy with our fictional casino simulator. Learn basic strategy, card counting concepts, and probability‚Äîall with zero risk and zero real money.";
---

<CasinoLayout title={title} description={description}>
    <!-- Game Controls Row: Deck Selector + Bet Selector -->
    <div class="flex flex-wrap items-center justify-between gap-4 p-4 rounded-xl" style="background: var(--surface-elevated);">
      <DeckSelector themes={DECK_THEMES} selectedId="emoji-default" />
      <div class="flex items-center gap-4">
        <label for="betSelect" class="text-sm" style="color: var(--text-secondary);">Bet:</label>
        <select
          id="betSelect"
          class="px-3 py-2 rounded-lg font-bold text-sm"
          style="background: var(--surface); color: var(--accent-primary); border: 1px solid var(--border-primary);"
        >
          <option value="5">5 CC</option>
          <option value="10">10 CC</option>
          <option value="25">25 CC</option>
          <option value="50">50 CC</option>
        </select>
        <div id="catnip-change" class="text-sm font-bold hidden"></div>
      </div>
    </div>

    <!-- Game Area -->
    <div class="space-y-6">
      <!-- Dealer Section -->
      <div class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated);">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold" style="color: var(--text-primary);">
            üé© Dealer
          </h2>
          <div class="text-lg font-mono" style="color: var(--text-secondary);">
            Total: <span id="dealer-total" class="font-bold" style="color: var(--text-primary);">0</span>
          </div>
        </div>
        <div id="dealer-hand" class="flex gap-4 flex-wrap justify-center min-h-[120px] items-center">
          <!-- Cards rendered here -->
        </div>
      </div>

      <!-- Player Section (supports multiple hands for splitting) -->
      <div id="player-section" class="space-y-4">
        <!-- Primary Hand -->
        <div id="player-hand-0-container" class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated); border: 2px solid var(--accent-primary);">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold" style="color: var(--text-primary);">
              üéÆ <span id="player-hand-0-label">You</span>
              <span id="player-hand-0-active" class="text-sm ml-2 px-2 py-0.5 rounded-full hidden" style="background: var(--accent-primary); color: var(--text-on-accent);">Active</span>
            </h2>
            <div class="text-lg font-mono" style="color: var(--text-secondary);">
              Total: <span id="player-total" class="font-bold" style="color: var(--text-primary);">0</span>
              <span id="player-hand-0-result" class="text-sm ml-2 hidden"></span>
            </div>
          </div>
          <div id="player-hand" class="flex gap-4 flex-wrap justify-center min-h-[120px] items-center">
            <!-- Cards rendered here -->
          </div>
        </div>

        <!-- Split Hand 2 (hidden until split occurs) -->
        <div id="player-hand-1-container" class="p-6 rounded-xl space-y-4 hidden" style="background: var(--surface-elevated); border: 2px solid var(--border-primary);">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold" style="color: var(--text-primary);">
              üéÆ <span id="player-hand-1-label">Hand 2</span>
              <span id="player-hand-1-active" class="text-sm ml-2 px-2 py-0.5 rounded-full hidden" style="background: var(--accent-primary); color: var(--text-on-accent);">Active</span>
            </h2>
            <div class="text-lg font-mono" style="color: var(--text-secondary);">
              Total: <span id="player-total-1" class="font-bold" style="color: var(--text-primary);">0</span>
              <span id="player-hand-1-result" class="text-sm ml-2 hidden"></span>
            </div>
          </div>
          <div id="player-hand-1" class="flex gap-4 flex-wrap justify-center min-h-[120px] items-center">
            <!-- Cards rendered here -->
          </div>
        </div>

        <!-- Split Hand 3 (hidden until re-split) -->
        <div id="player-hand-2-container" class="p-6 rounded-xl space-y-4 hidden" style="background: var(--surface-elevated); border: 2px solid var(--border-primary);">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold" style="color: var(--text-primary);">
              üéÆ <span id="player-hand-2-label">Hand 3</span>
              <span id="player-hand-2-active" class="text-sm ml-2 px-2 py-0.5 rounded-full hidden" style="background: var(--accent-primary); color: var(--text-on-accent);">Active</span>
            </h2>
            <div class="text-lg font-mono" style="color: var(--text-secondary);">
              Total: <span id="player-total-2" class="font-bold" style="color: var(--text-primary);">0</span>
              <span id="player-hand-2-result" class="text-sm ml-2 hidden"></span>
            </div>
          </div>
          <div id="player-hand-2" class="flex gap-4 flex-wrap justify-center min-h-[120px] items-center">
            <!-- Cards rendered here -->
          </div>
        </div>

        <!-- Split Hand 4 (hidden until re-split) -->
        <div id="player-hand-3-container" class="p-6 rounded-xl space-y-4 hidden" style="background: var(--surface-elevated); border: 2px solid var(--border-primary);">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold" style="color: var(--text-primary);">
              üéÆ <span id="player-hand-3-label">Hand 4</span>
              <span id="player-hand-3-active" class="text-sm ml-2 px-2 py-0.5 rounded-full hidden" style="background: var(--accent-primary); color: var(--text-on-accent);">Active</span>
            </h2>
            <div class="text-lg font-mono" style="color: var(--text-secondary);">
              Total: <span id="player-total-3" class="font-bold" style="color: var(--text-primary);">0</span>
              <span id="player-hand-3-result" class="text-sm ml-2 hidden"></span>
            </div>
          </div>
          <div id="player-hand-3" class="flex gap-4 flex-wrap justify-center min-h-[120px] items-center">
            <!-- Cards rendered here -->
          </div>
        </div>
      </div>

      <!-- Game Controls -->
      <div class="flex gap-3 flex-wrap justify-center">
        <button
          id="deal-btn"
          class="px-8 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105"
          style="background: var(--accent-primary); color: var(--text-on-accent);"
        >
          Deal Cards
        </button>
        <button
          id="hit-btn"
          class="px-8 py-3 rounded-lg font-bold text-lg transition-all"
          style="background: var(--surface-elevated); color: var(--text-primary); border: 2px solid var(--border-primary);"
          disabled
        >
          Hit
        </button>
        <button
          id="stand-btn"
          class="px-8 py-3 rounded-lg font-bold text-lg transition-all"
          style="background: var(--surface-elevated); color: var(--text-primary); border: 2px solid var(--border-primary);"
          disabled
        >
          Stand
        </button>
        <button
          id="split-btn"
          class="px-8 py-3 rounded-lg font-bold text-lg transition-all hidden"
          style="background: var(--accent-warning); color: var(--text-on-accent); border: 2px solid var(--accent-warning);"
          disabled
        >
          ‚úÇÔ∏è Split
        </button>
        <button
          id="double-btn"
          class="px-8 py-3 rounded-lg font-bold text-lg transition-all"
          style="background: var(--accent-secondary); color: var(--text-on-accent); border: 2px solid var(--accent-secondary);"
          disabled
        >
          Double Down
        </button>
        <button
          id="deal-again-btn"
          class="px-8 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 hidden"
          style="background: var(--accent-primary); color: var(--text-on-accent);"
        >
          üé≤ Deal Again
        </button>
      </div>

      <!-- Game Status -->
      <div
        id="game-status"
        class="p-6 rounded-xl text-center hidden"
        style="background: var(--surface-elevated);"
      >
        <p id="status-message" class="text-2xl font-bold mb-2" style="color: var(--text-primary);"></p>
        <p id="status-detail" class="text-sm" style="color: var(--text-secondary);"></p>
      </div>

      <!-- Insurance Prompt (shows when dealer has Ace) -->
      <div
        id="insurance-prompt"
        class="p-6 rounded-xl text-center hidden"
        style="background: var(--surface-elevated); border: 2px solid var(--accent-warning);"
      >
        <div class="flex items-center justify-center gap-2 mb-3">
          <span class="text-2xl">üõ°Ô∏è</span>
          <p class="text-xl font-bold" style="color: var(--text-primary);">Insurance?</p>
        </div>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">
          Dealer shows an Ace. Take insurance for <span id="insurance-cost" class="font-bold" style="color: var(--accent-warning);">2.5 CC</span>?
          <br/>
          <span class="text-xs">Pays 2:1 if dealer has Blackjack.</span>
        </p>
        <div class="flex gap-3 justify-center">
          <button
            id="insurance-yes-btn"
            class="px-6 py-2 rounded-lg font-bold text-sm transition-all hover:scale-105"
            style="background: var(--accent-warning); color: var(--text-on-accent);"
          >
            Yes, Take Insurance
          </button>
          <button
            id="insurance-no-btn"
            class="px-6 py-2 rounded-lg font-bold text-sm transition-all hover:scale-105"
            style="background: var(--surface); color: var(--text-primary); border: 2px solid var(--border-primary);"
          >
            No Thanks
          </button>
        </div>
      </div>
    </div>

    <!-- How to Play -->
    <div class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated);">
      <h2 class="text-2xl font-bold" style="color: var(--text-primary);">How to Play</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">üéØ Objective</h3>
          <p style="color: var(--text-secondary);">
            Get as close to 21 as possible without going over (busting). Beat the dealer's hand to win.
          </p>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">üÉè Card Values</h3>
          <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
            <li>‚Ä¢ Number cards (2-10): Face value</li>
            <li>‚Ä¢ Face cards (J, Q, K): 10 points</li>
            <li>‚Ä¢ Ace: 1 or 11 (whichever is better)</li>
          </ul>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">üéÆ Actions</h3>
          <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
            <li>‚Ä¢ <strong>Hit:</strong> Take another card</li>
            <li>‚Ä¢ <strong>Stand:</strong> Keep your current hand</li>
            <li>‚Ä¢ <strong>Split:</strong> Split a pair into two hands (requires additional bet). Can re-split up to 4 hands total. Split aces get 1 card each and cannot be re-split.</li>
            <li>‚Ä¢ <strong>Insurance:</strong> When dealer shows an Ace, you can take insurance (half your bet). Pays 2:1 if dealer has Blackjack.</li>
            <li>‚Ä¢ <strong>Double Down:</strong> Double your bet, get exactly one card, then forced stand</li>
            <li>‚Ä¢ <strong>Blackjack:</strong> Ace + 10-value card pays 3:2 (1.5√ó your bet)</li>
          </ul>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">üè† Dealer Rules</h3>
          <p class="text-sm" style="color: var(--text-secondary);">
            Dealer must hit on 16 or less and stand on 17 or more. These are standard casino rules.
          </p>
        </div>
      </div>
    </div>

    <!-- Basic Strategy Quick Reference -->
    <div class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated);">
      <h2 class="text-2xl font-bold" style="color: var(--text-primary);">üìä Basic Strategy Quick Reference</h2>
      <p class="text-sm" style="color: var(--text-secondary);">
        These simplified guidelines cover the most common decisions. Real basic strategy charts are more nuanced but this covers ~90% of situations.
      </p>
      <div class="grid md:grid-cols-2 gap-6 mt-4">
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">When to Hit</h3>
          <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
            <li>‚Ä¢ Always hit on 8 or less</li>
            <li>‚Ä¢ Hit on 12 if dealer shows 2 or 3</li>
            <li>‚Ä¢ Hit on 12-16 if dealer shows 7 or higher</li>
            <li>‚Ä¢ Hit on soft 17 (A+6) against dealer 9, 10, A</li>
          </ul>
        </div>
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">When to Stand</h3>
          <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
            <li>‚Ä¢ Always stand on 17 or higher (hard total)</li>
            <li>‚Ä¢ Stand on 12-16 if dealer shows 2-6 (dealer likely to bust)</li>
            <li>‚Ä¢ Stand on soft 19 (A+8) or higher</li>
          </ul>
        </div>
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-warning);">When to Split</h3>
          <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
            <li>‚Ä¢ <strong>Always split:</strong> Aces and 8s</li>
            <li>‚Ä¢ <strong>Never split:</strong> 10s and 5s</li>
            <li>‚Ä¢ Split 2s, 3s, 6s, 7s against dealer 2-7</li>
            <li>‚Ä¢ Split 9s against 2-6, 8-9 (not 7, 10, A)</li>
            <li>‚Ä¢ Split 4s only against dealer 5-6</li>
            <li>‚Ä¢ <strong>Re-split:</strong> You can split again (up to 4 hands) if dealt another pair</li>
            <li>‚Ä¢ <strong>Aces rule:</strong> Split aces get only 1 card each and cannot be re-split</li>
          </ul>
        </div>
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-secondary);">When to Double Down</h3>
          <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
            <li>‚Ä¢ Double on 11 against any dealer card except A</li>
            <li>‚Ä¢ Double on 10 against dealer 2-9</li>
            <li>‚Ä¢ Double on 9 against dealer 3-6</li>
            <li>‚Ä¢ Double on soft 16-18 against dealer 4-6</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Educational Content -->
    <div class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated);">
      <h2 class="text-2xl font-bold" style="color: var(--text-primary);">üìö Understanding Blackjack</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">Why Basic Strategy Works</h3>
          <p class="text-sm" style="color: var(--text-secondary);">
            Basic strategy is derived from computer simulations of millions of hands. For every combination of your cards and the dealer's up-card, mathematicians calculated the expected value of each action (hit, stand, double, split). The strategy tells you which action has the best expected outcome over time.
          </p>
        </div>
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">The House Edge Explained</h3>
          <p class="text-sm" style="color: var(--text-secondary);">
            With perfect basic strategy, blackjack has one of the lowest house edges in casinos (~0.5%). This means for every $100 wagered, you expect to lose about $0.50 on average. Without strategy, the house edge increases to 2-4%. The house edge comes from the player acting first and busting before the dealer plays.
          </p>
        </div>
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">Card Counting Reality</h3>
          <p class="text-sm" style="color: var(--text-secondary);">
            While card counting can give a small edge (0.5-1.5%), it requires extensive practice, is mentally exhausting, and casinos actively counter it by using multiple decks, shuffling frequently, and banning suspected counters. This simulator does NOT teach card counting.
          </p>
        </div>
        <div class="space-y-3">
          <h3 class="text-lg font-semibold" style="color: var(--accent-primary);">Variance & Bankroll</h3>
          <p class="text-sm" style="color: var(--text-secondary);">
            Even with perfect play, you can lose many hands in a row due to variance. A typical session might see 10+ losing hands consecutively. No strategy guarantees wins‚Äîbasic strategy only minimizes losses over the long run. Never gamble with money you can't afford to lose.
          </p>
        </div>
      </div>
    </div>

    <!-- Probability Facts -->
    <div class="p-6 rounded-xl space-y-4" style="background: var(--surface-elevated);">
      <h2 class="text-2xl font-bold" style="color: var(--text-primary);">üé≤ Blackjack Probability Facts</h2>
      <div class="grid sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
          <div class="text-2xl font-bold" style="color: var(--accent-primary);">4.8%</div>
          <div class="text-xs mt-1" style="color: var(--text-secondary);">Chance of natural blackjack</div>
        </div>
        <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
          <div class="text-2xl font-bold" style="color: var(--accent-primary);">28%</div>
          <div class="text-xs mt-1" style="color: var(--text-secondary);">Dealer bust probability</div>
        </div>
        <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
          <div class="text-2xl font-bold" style="color: var(--accent-primary);">42%</div>
          <div class="text-xs mt-1" style="color: var(--text-secondary);">Hands where you should hit</div>
        </div>
        <div class="p-4 rounded-lg" style="background: var(--surface); border: 1px solid var(--border-primary);">
          <div class="text-2xl font-bold" style="color: var(--accent-primary);">0.5%</div>
          <div class="text-xs mt-1" style="color: var(--text-secondary);">House edge with basic strategy</div>
        </div>
      </div>
      <p class="text-xs mt-2 text-center" style="color: var(--text-muted);">
        Statistics based on single-deck blackjack with standard rules. Multi-deck games have slightly different odds.
      </p>
    </div>

    <!-- Gameplay Settings Accordion -->
    <details class="rounded-xl" style="background: var(--surface-elevated);">
      <summary class="p-4 cursor-pointer font-semibold text-sm" style="color: var(--text-primary);">
        ‚öôÔ∏è Gameplay Settings
      </summary>
      <div class="p-4 pt-0 space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="deckModeSelect" class="block text-xs mb-1" style="color: var(--text-secondary);">Deck Mode</label>
            <select
              id="deckModeSelect"
              class="w-full px-3 py-2 rounded-lg text-sm"
              style="background: var(--surface); color: var(--text-primary); border: 1px solid var(--border-primary);"
            >
              <option value="shoe">Persistent Shoe</option>
              <option value="fresh">Fresh Shuffle Each Round</option>
              <option value="infinite">Infinite Deck (RNG)</option>
            </select>
            <p id="deckModeDesc" class="mt-1 text-xs" style="color: var(--text-muted);">Cards dealt from a multi-deck shoe without replacement.</p>
          </div>
          <div>
            <label for="deckCountSelect" class="block text-xs mb-1" style="color: var(--text-secondary);">Number of Decks</label>
            <select
              id="deckCountSelect"
              class="w-full px-3 py-2 rounded-lg text-sm"
              style="background: var(--surface); color: var(--text-primary); border: 1px solid var(--border-primary);"
            >
              <option value="1">1 Deck</option>
              <option value="2">2 Decks</option>
              <option value="4">4 Decks</option>
              <option value="6" selected>6 Decks</option>
              <option value="8">8 Decks</option>
            </select>
          </div>
        </div>
        <div id="reshuffleOptions">
          <label for="reshuffleSelect" class="block text-xs mb-1" style="color: var(--text-secondary);">Reshuffle Threshold (Shoe mode only)</label>
          <select
            id="reshuffleSelect"
            class="w-full sm:w-auto px-3 py-2 rounded-lg text-sm"
            style="background: var(--surface); color: var(--text-primary); border: 1px solid var(--border-primary);"
          >
            <option value="0.5">50% dealt</option>
            <option value="0.75" selected>75% dealt</option>
          </select>
        </div>
        <p class="text-xs" style="color: var(--text-muted);">
          Changing settings will reset the current game.
        </p>
      </div>
    </details>

    <!-- Fairness & RNG Disclosure -->
    <details class="rounded-xl" style="background: var(--surface-elevated);">
      <summary class="p-4 cursor-pointer font-semibold text-sm" style="color: var(--text-primary);">
        üé≤ Fairness & RNG
      </summary>
      <div class="p-4 pt-0 space-y-2 text-xs" style="color: var(--text-secondary);">
        <p>
          <strong style="color: var(--text-primary);">Random Number Generation:</strong>
          All shuffles use the Web Crypto API (<code style="background: var(--surface); padding: 2px 6px; border-radius: 4px;">crypto.getRandomValues()</code>),
          providing cryptographically secure randomness.
        </p>
        <p id="currentModeDescription">
          <strong style="color: var(--text-primary);">Current Mode:</strong>
          <span id="currentModeLabel">Persistent Shoe</span> ‚Äî Cards are dealt from a multi-deck shoe without replacement. Reshuffles when running low.
        </p>
        <p style="color: var(--text-muted);">
          This is for entertainment and education only. No real money is involved. MintyCatnipCoin (MCC) is a fictional currency with no value.
        </p>
      </div>
    </details>

</CasinoLayout>

<script>
  import { generateStandardDeck, shuffleDeck, formatCard } from '../../utils/cardDeck';
  import { getDeckTheme, getSuitSet } from '../../config/decks';
  import type { Card } from '../../types/cards';
  import {
    getCatnipBalance,
    addCatnip,
    subtractCatnip,
    formatCatnip
  } from '../../utils/catnipCoin';

  // Game state
  let deck: Card[] = [];
  let dealerHand: Card[] = [];
  let gameOver = false;
  let baseBet = 5; // Base CatnipCoin bet
  let currentThemeId = 'emoji-default';

  // Multi-hand state for splitting (Phase 4.6)
  const MAX_HANDS = 4; // Standard casino max (can't split beyond 4 hands)
  let hands: Card[][] = [[]]; // Array of hands (normally 1, up to 4 when re-splitting)
  let bets: number[] = [baseBet]; // Bet per hand
  let activeHandIndex = 0; // Which hand is currently being played
  let handDoubled: boolean[] = [false]; // Track if each hand was doubled down
  let handResults: ('win' | 'lose' | 'push' | 'blackjack' | null)[] = [null];
  let handFromAces: boolean[] = [false]; // Track which hands came from split aces (can't re-split)
  let isSplitGame = false; // Track if we're in a split scenario
  let splitAces = false; // Special case: split aces get only one card each (first split only)

  // Insurance state (Phase 4.6)
  let insuranceBet = 0; // Half of base bet
  let insuranceTaken = false; // Whether player took insurance

  // Deck mode settings
  type DeckMode = 'shoe' | 'fresh' | 'infinite';
  let deckMode: DeckMode = 'shoe';
  let deckCount = 6;
  let reshuffleThreshold = 0.75;

  const modeDescriptions: Record<DeckMode, string> = {
    shoe: 'Cards dealt from a multi-deck shoe without replacement. Reshuffles when running low.',
    fresh: 'A completely shuffled deck for each round. No card memory between hands.',
    infinite: 'Each card drawn independently with replacement. Any card can appear multiple times.'
  };

  const modeLabels: Record<DeckMode, string> = {
    shoe: 'Persistent Shoe',
    fresh: 'Fresh Shuffle',
    infinite: 'Infinite Deck'
  };
  let insurancePromptActive = false; // Is the prompt showing

  // Backward compatibility alias
  let playerHand: Card[] = hands[0];
  let isDoubledDown = false;

  // Load saved theme
  const savedTheme = localStorage.getItem('casino-deck-theme');
  if (savedTheme) {
    currentThemeId = savedTheme;
  }

  // Listen for theme changes
  window.addEventListener('deckThemeChange', ((e: CustomEvent) => {
    currentThemeId = e.detail;
    renderHands();
  }) as EventListener);

  // Update CatnipCoin balance display (in header via CasinoLayout)
  function updateBalanceDisplay() {
    const balance = getCatnipBalance();
    const balanceEl = document.getElementById('header-balance-value');
    if (balanceEl) {
      balanceEl.textContent = balance.toLocaleString();
    }
  }

  // Show CatnipCoin change animation
  function showCatnipChange(amount: number, reason: string) {
    const changeEl = document.getElementById('catnip-change');
    if (changeEl) {
      const sign = amount > 0 ? '+' : '';
      changeEl.textContent = `${sign}${amount} CC (${reason})`;
      changeEl.style.color = amount > 0 ? 'var(--accent-success)' : 'var(--accent-warning)';
      changeEl.classList.remove('hidden');
      setTimeout(() => {
        changeEl.classList.add('hidden');
      }, 3000);
    }
  }

  // Listen for balance changes
  window.addEventListener('catnipBalanceChange', updateBalanceDisplay as EventListener);

  // Calculate hand total
  function calculateTotal(hand: Card[]): number {
    let total = 0;
    let aces = 0;

    for (const card of hand) {
      if (card.rank === 'A') {
        aces++;
        total += 11;
      } else if (['J', 'Q', 'K'].includes(card.rank)) {
        total += 10;
      } else {
        total += parseInt(card.rank);
      }
    }

    // Adjust for aces
    while (total > 21 && aces > 0) {
      total -= 10;
      aces--;
    }

    return total;
  }

  // Asset resolver - ensures JPEG fallback (matches CardView.astro)
  function resolveAsset(src: string | undefined): string | null {
    if (!src) return null;
    return src
      .replace('.webp', '.jpeg')
      .replace('.jpg', '.jpeg')
      .replace('.svg', '.jpeg');
  }

  // Render a single card with Phase 4.4 visual polish (matches CardView.astro)
  function renderCard(card: Card, faceDown = false): string {
    const theme = getDeckTheme(currentThemeId);
    const suitSet = getSuitSet(theme.suitSetId);
    const suitIcon = suitSet.icons[card.suit];
    const isEmoji = !suitIcon.startsWith('/');
    const cardColor = (card.suit === 'hearts' || card.suit === 'diamonds') ? 'text-red-600' : 'text-slate-900';
    const ariaLabel = faceDown ? 'Face down card' : formatCard(card);

    // Resolve image paths
    const frontSrc = resolveAsset((theme as any).frontBySuit?.[card.suit] ?? (theme as any).frontImage);
    const backSrc = resolveAsset((theme as any).backImage);
    const cardImageSrc = faceDown ? backSrc : frontSrc;

    // Build inner mask with image/pattern
    let innerContent = '';
    if (cardImageSrc) {
      innerContent = `
        <div class="absolute inset-0 p-[2%]">
          <div class="w-full h-full bg-cover bg-center" style="background-image: url('${cardImageSrc}')"></div>
        </div>
      `;
    } else if (theme.background && !faceDown) {
      innerContent = `<div class="absolute inset-0 ${theme.background}"></div>`;
    } else if (faceDown) {
      innerContent = `
        <div class="absolute inset-0 ${theme.backPattern || 'bg-emerald-700'} flex items-center justify-center">
          <div class="text-white text-2xl opacity-20">üé¥</div>
        </div>
      `;
    } else {
      innerContent = `<div class="absolute inset-0 bg-white"></div>`;
    }

    // Build rank/suit overlay (face-up only)
    let overlayContent = '';
    if (!faceDown) {
      overlayContent = `
        <div class="absolute inset-0 pointer-events-none">
          <!-- Top-left -->
          <div class="absolute top-[6%] left-[7%]">
            <div class="flex flex-col items-center justify-center leading-none text-[0.7rem] sm:text-[0.8rem] drop-shadow-[0_0_3px_rgba(0,0,0,0.5)] ${cardColor}">
              <span class="${theme.rankFontClass}">${card.rank}</span>
              <span>${isEmoji ? suitIcon : `<img src="${suitIcon}" alt="${card.suit}" class="w-3 h-3 sm:w-4 sm:h-4"/>`}</span>
            </div>
          </div>
          <!-- Center -->
          <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
            <span class="text-[1.8rem] sm:text-[2rem] opacity-80 drop-shadow-[0_0_4px_rgba(0,0,0,0.6)] ${cardColor}">
              ${isEmoji ? suitIcon : `<img src="${suitIcon}" alt="${card.suit}" class="w-10 h-10 sm:w-12 sm:h-12 opacity-80" style="filter: drop-shadow(0 0 4px rgba(0,0,0,0.6));"/>`}
            </span>
          </div>
          <!-- Bottom-right -->
          <div class="absolute bottom-[6%] right-[7%] rotate-180">
            <div class="flex flex-col items-center justify-center leading-none text-[0.7rem] sm:text-[0.8rem] drop-shadow-[0_0_3px_rgba(0,0,0,0.5)] ${cardColor}">
              <span class="${theme.rankFontClass}">${card.rank}</span>
              <span>${isEmoji ? suitIcon : `<img src="${suitIcon}" alt="${card.suit}" class="w-3 h-3 sm:w-4 sm:h-4"/>`}</span>
            </div>
          </div>
        </div>
      `;
    }

    return `
      <div class="relative w-[80px] sm:w-[90px] aspect-[3/4] ${theme.cardFrameClass} transition-transform duration-200 hover:-translate-y-0.5 hover:shadow-lg" role="img" aria-label="${ariaLabel}">
        <div class="absolute inset-0 rounded-xl overflow-hidden">
          ${innerContent}
        </div>
        ${overlayContent}
      </div>
    `;
  }

  // Render hands (supports multiple hands for splitting)
  function renderHands() {
    const dealerHandEl = document.getElementById('dealer-hand');
    const dealerTotalEl = document.getElementById('dealer-total');

    // Render dealer hand
    if (dealerHandEl && dealerTotalEl) {
      if (dealerHand.length > 0 && !gameOver) {
        dealerHandEl.innerHTML = renderCard(dealerHand[0], true) + dealerHand.slice(1).map(card => renderCard(card)).join('');
        const visibleTotal = calculateTotal(dealerHand.slice(1));
        dealerTotalEl.textContent = visibleTotal.toString();
      } else {
        dealerHandEl.innerHTML = dealerHand.map(card => renderCard(card)).join('');
        dealerTotalEl.textContent = calculateTotal(dealerHand).toString();
      }
    }

    // Render player hand(s)
    for (let i = 0; i < hands.length; i++) {
      const handEl = document.getElementById(i === 0 ? 'player-hand' : `player-hand-${i}`);
      const totalEl = document.getElementById(i === 0 ? 'player-total' : `player-total-${i}`);
      const containerEl = document.getElementById(`player-hand-${i}-container`);
      const activeEl = document.getElementById(`player-hand-${i}-active`);
      const resultEl = document.getElementById(`player-hand-${i}-result`);
      const labelEl = document.getElementById(`player-hand-${i}-label`);

      if (handEl && totalEl) {
        handEl.innerHTML = hands[i].map(card => renderCard(card)).join('');
        totalEl.textContent = calculateTotal(hands[i]).toString();
      }

      // Show/hide container for split hands
      if (containerEl) {
        containerEl.classList.toggle('hidden', i > 0 && !isSplitGame);

        // Update border for active hand
        if (isSplitGame && !gameOver) {
          containerEl.style.borderColor = i === activeHandIndex ? 'var(--accent-primary)' : 'var(--border-primary)';
        }
      }

      // Show active indicator
      if (activeEl) {
        activeEl.classList.toggle('hidden', !isSplitGame || i !== activeHandIndex || gameOver);
      }

      // Update label for split hands
      if (labelEl && isSplitGame) {
        labelEl.textContent = `Hand ${i + 1}`;
      } else if (labelEl) {
        labelEl.textContent = 'You';
      }

      // Show result for completed hands
      if (resultEl && handResults[i]) {
        resultEl.classList.remove('hidden');
        resultEl.textContent = handResults[i] === 'win' ? '‚úì Won' :
                               handResults[i] === 'blackjack' ? 'üé∞ BJ!' :
                               handResults[i] === 'lose' ? '‚úó Lost' : '‚Üî Push';
        resultEl.style.color = handResults[i] === 'win' || handResults[i] === 'blackjack' ? 'var(--accent-success)' :
                               handResults[i] === 'lose' ? 'var(--accent-danger)' : 'var(--accent-warning)';
      } else if (resultEl) {
        resultEl.classList.add('hidden');
      }
    }
  }

  // Show status message
  function showStatus(message: string, detail: string, type: 'win' | 'lose' | 'push') {
    const statusEl = document.getElementById('game-status');
    const messageEl = document.getElementById('status-message');
    const detailEl = document.getElementById('status-detail');

    if (statusEl && messageEl && detailEl) {
      statusEl.classList.remove('hidden');
      messageEl.textContent = message;
      detailEl.textContent = detail;

      // Color coding
      if (type === 'win') {
        messageEl.style.color = 'var(--accent-success)';
      } else if (type === 'lose') {
        messageEl.style.color = 'var(--accent-danger)';
      } else {
        messageEl.style.color = 'var(--accent-warning)';
      }
    }
  }

  // Hide status message
  function hideStatus() {
    const statusEl = document.getElementById('game-status');
    if (statusEl) {
      statusEl.classList.add('hidden');
    }
  }

  // Check for natural blackjack (ONLY on initial 2 cards)
  function hasNaturalBlackjack(hand: Card[]): boolean {
    return hand.length === 2 && calculateTotal(hand) === 21;
  }

  // Check if hand is busted
  function isBusted(hand: Card[]): boolean {
    return calculateTotal(hand) > 21;
  }
  
  // Check if current active hand can split (Phase 4.6 - full re-split support)
  function canSplit(): boolean {
    const currentHand = hands[activeHandIndex];

    // Must have exactly 2 cards
    if (!currentHand || currentHand.length !== 2) return false;

    // Can't split beyond MAX_HANDS (standard casino rule: 4 hands max)
    if (hands.length >= MAX_HANDS) return false;

    // Can't re-split aces (standard casino rule)
    if (handFromAces[activeHandIndex]) return false;

    // Must have matching values (rank for non-faces, value for faces)
    const card1 = currentHand[0];
    const card2 = currentHand[1];

    // Same rank (e.g., 7-7, A-A)
    if (card1.rank === card2.rank) return true;

    // Both are 10-value cards (10, J, Q, K)
    const tenValues = ['10', 'J', 'Q', 'K'];
    if (tenValues.includes(card1.rank) && tenValues.includes(card2.rank)) return true;

    return false;
  }

  // Check if player has enough balance to split
  function canAffordSplit(): boolean {
    return getCatnipBalance() >= baseBet;
  }

  // Dealer play
  function dealerPlay() {
    // Reveal dealer's hidden card
    gameOver = true;
    renderHands();

    // Dealer hits on 16 or less
    const hitDealer = () => {
      if (calculateTotal(dealerHand) < 17) {
        setTimeout(() => {
          dealerHand.push(drawGameCard());
          renderHands();
          hitDealer();
        }, 600);
      } else {
        checkWinner();
      }
    };

    hitDealer();
  }

  // Settle a single hand against dealer
  function settleHand(handIndex: number, dealerTotal: number): { result: 'win' | 'lose' | 'push' | 'blackjack', payout: number } {
    const hand = hands[handIndex];
    const handTotal = calculateTotal(hand);
    const bet = bets[handIndex] * (handDoubled[handIndex] ? 2 : 1);

    // Already busted during play (for split hands)
    if (handResults[handIndex] === 'lose') {
      return { result: 'lose', payout: 0 };
    }

    const dealerBusted = dealerTotal > 21;

    // Note: Natural blackjack (3:2) is NOT available after split
    if (handTotal > 21) {
      // Player busted
      return { result: 'lose', payout: 0 };
    } else if (dealerBusted) {
      // Dealer busted, player wins 1:1
      return { result: 'win', payout: bet * 2 };
    } else if (handTotal > dealerTotal) {
      // Player wins 1:1
      return { result: 'win', payout: bet * 2 };
    } else if (dealerTotal > handTotal) {
      // Dealer wins
      return { result: 'lose', payout: 0 };
    } else {
      // Push
      return { result: 'push', payout: bet };
    }
  }

  // Settlement - Centralized payout logic
  function checkWinner() {
    const dealerTotal = calculateTotal(dealerHand);

    if (isSplitGame) {
      // Multi-hand settlement
      let totalPayout = 0;
      let wins = 0;
      let losses = 0;
      let pushes = 0;

      for (let i = 0; i < hands.length; i++) {
        const { result, payout } = settleHand(i, dealerTotal);
        handResults[i] = result;
        totalPayout += payout;

        if (result === 'win' || result === 'blackjack') wins++;
        else if (result === 'lose') losses++;
        else pushes++;
      }

      // Update hand result displays
      renderHands();

      // Calculate net result (total payout minus total wagered)
      const totalWagered = bets.reduce((sum, b, i) => sum + b * (handDoubled[i] ? 2 : 1), 0);
      const netChange = totalPayout - totalWagered;

      // Pay out winnings
      if (totalPayout > 0) {
        addCatnip(totalPayout, 'Blackjack split payout');
      }

      // Show summary status
      if (wins > losses) {
        showStatus(`Won ${wins}/${hands.length} hands! üéâ`, `Net: ${netChange >= 0 ? '+' : ''}${netChange} CC`, 'win');
        showCatnipChange(netChange, 'Split Result');
      } else if (losses > wins) {
        showStatus(`Lost ${losses}/${hands.length} hands üòî`, `Net: ${netChange >= 0 ? '+' : ''}${netChange} CC`, 'lose');
        showCatnipChange(netChange, 'Split Result');
      } else {
        showStatus(`Split result: ${wins}W/${losses}L/${pushes}P`, `Net: ${netChange >= 0 ? '+' : ''}${netChange} CC`, 'push');
        showCatnipChange(netChange, 'Split Result');
      }
    } else {
      // Single hand settlement (original logic)
      const playerTotal = calculateTotal(playerHand);
      const playerNatural = hasNaturalBlackjack(playerHand);
      const dealerNatural = hasNaturalBlackjack(dealerHand);

      // Current bet (may be doubled)
      const currentBet = baseBet * (isDoubledDown ? 2 : 1);

      // Settlement outcomes:
      // - Player bust: lose bet
      // - Dealer bust: win 1:1 (return bet + winnings)
      // - Natural BJ vs non-BJ: win 3:2 (return bet + 1.5x winnings)
      // - Both natural BJ: push (return bet)
      // - Compare totals: win 1:1, lose bet, or push

      if (playerTotal > 21) {
        // Player busted - lose bet
        showStatus('Bust! üí•', `You went over 21 with ${playerTotal}.`, 'lose');
        showCatnipChange(-currentBet, 'Bust');
      } else if (dealerTotal > 21) {
        // Dealer busted - win 1:1
        const payout = currentBet * 2; // Return bet + winnings
        showStatus('You Win! üéâ', `Dealer busted with ${dealerTotal}.`, 'win');
        addCatnip(payout, isDoubledDown ? 'Blackjack doubled down win' : 'Blackjack win');
        showCatnipChange(+payout, isDoubledDown ? 'Doubled Win!' : 'Win');
      } else if (playerNatural && !dealerNatural) {
        // Natural blackjack pays 3:2 (only on base bet, not doubled)
        const payout = Math.floor(baseBet * 2.5); // Bet + 1.5x winnings
        showStatus('Blackjack! üé∞', 'Natural 21 pays 3:2!', 'win');
        addCatnip(payout, 'Blackjack natural 21');
        showCatnipChange(+payout, 'Blackjack!');
      } else if (dealerNatural && !playerNatural) {
        // Dealer has natural BJ - lose bet
        showStatus('Dealer Blackjack üé©', 'Dealer has natural 21.', 'lose');
        showCatnipChange(-currentBet, 'Loss');
      } else if (playerNatural && dealerNatural) {
        // Both have natural BJ - push
        showStatus('Push ü§ù', 'Both have Blackjack!', 'push');
        addCatnip(currentBet, 'Blackjack push');
        showCatnipChange(0, 'Push');
      } else if (playerTotal > dealerTotal) {
        // Player wins - 1:1 payout
        const payout = currentBet * 2; // Return bet + winnings
        showStatus('You Win! üéâ', `${playerTotal} beats ${dealerTotal}.`, 'win');
        addCatnip(payout, isDoubledDown ? 'Blackjack doubled down win' : 'Blackjack win');
        showCatnipChange(+payout, isDoubledDown ? 'Doubled Win!' : 'Win');
      } else if (dealerTotal > playerTotal) {
        // Dealer wins - lose bet
        showStatus('Dealer Wins üé©', `${dealerTotal} beats ${playerTotal}.`, 'lose');
        showCatnipChange(-currentBet, 'Loss');
      } else {
        // Tie - push (return bet)
        showStatus('Push ü§ù', `Both have ${playerTotal}. It's a tie!`, 'push');
        addCatnip(currentBet, 'Blackjack push');
        showCatnipChange(0, 'Push');
      }
    }

    updateButtons(false, false, false, true);
  }

  // Update button states
  function updateButtons(hit: boolean, stand: boolean, doubleDown: boolean, deal: boolean) {
    const hitBtn = document.getElementById('hit-btn') as HTMLButtonElement;
    const standBtn = document.getElementById('stand-btn') as HTMLButtonElement;
    const doubleBtn = document.getElementById('double-btn') as HTMLButtonElement;
    const splitBtn = document.getElementById('split-btn') as HTMLButtonElement;
    const dealBtn = document.getElementById('deal-btn') as HTMLButtonElement;
    const dealAgainBtn = document.getElementById('deal-again-btn') as HTMLButtonElement;
    const betSelect = document.getElementById('betSelect') as HTMLSelectElement;

    if (hitBtn) hitBtn.disabled = !hit;
    if (standBtn) standBtn.disabled = !stand;
    if (doubleBtn) doubleBtn.disabled = !doubleDown;

    // Re-enable bet selector when game is over (deal button is shown)
    if (betSelect) betSelect.disabled = !deal;
    
    // Split button logic (Phase 4.6 - supports re-splitting up to 4 hands)
    if (splitBtn) {
      const currentHand = hands[activeHandIndex];
      const canSplitNow = canSplit() && canAffordSplit() && !gameOver && currentHand?.length === 2;
      splitBtn.classList.toggle('hidden', !canSplitNow);
      splitBtn.disabled = !canSplitNow;
    }
    
    // Show Deal Again instead of Deal Cards when game is over
    if (dealBtn && dealAgainBtn) {
      if (deal) {
        dealBtn.classList.add('hidden');
        dealAgainBtn.classList.remove('hidden');
      } else {
        dealBtn.classList.remove('hidden');
        dealAgainBtn.classList.add('hidden');
      }
    }
  }

  // Deal new hand
  function deal() {
    hideStatus();
    gameOver = false;
    isDoubledDown = false;

    // Get bet value from dropdown
    const betSelect = document.getElementById('betSelect') as HTMLSelectElement;
    baseBet = parseInt(betSelect?.value || '5', 10);

    // Disable bet selector during game
    if (betSelect) betSelect.disabled = true;

    // Reset split state for new hand
    hands = [[]];
    bets = [baseBet];
    activeHandIndex = 0;
    handDoubled = [false];
    handResults = [null];
    handFromAces = [false];
    isSplitGame = false;
    splitAces = false;

    // Hide all split hand containers from previous game
    for (let i = 1; i < 4; i++) {
      const container = document.getElementById(`player-hand-${i}-container`);
      if (container) {
        container.classList.add('hidden');
        container.style.borderColor = 'var(--border-primary)';
      }
      const handEl = document.getElementById(`player-hand-${i}`);
      if (handEl) handEl.innerHTML = '';
      const resultEl = document.getElementById(`player-hand-${i}-result`);
      if (resultEl) {
        resultEl.classList.add('hidden');
        resultEl.textContent = '';
      }
      const activeEl = document.getElementById(`player-hand-${i}-active`);
      if (activeEl) activeEl.classList.add('hidden');
    }
    // Reset primary hand label and result
    const hand0Label = document.getElementById('player-hand-0-label');
    if (hand0Label) hand0Label.textContent = 'You';
    const hand0Result = document.getElementById('player-hand-0-result');
    if (hand0Result) {
      hand0Result.classList.add('hidden');
      hand0Result.textContent = '';
    }
    const hand0Active = document.getElementById('player-hand-0-active');
    if (hand0Active) hand0Active.classList.add('hidden');

    // Reset insurance state
    insuranceBet = 0;
    insuranceTaken = false;
    insurancePromptActive = false;
    hideInsurancePrompt();

    // Deduct bet at deal time
    subtractCatnip(baseBet, 'Blackjack bet');

    // Fresh mode: shuffle a new deck each round
    if (deckMode === 'fresh') {
      deck = shuffleDeck(generateStandardDeck());
    } else if (deckMode === 'shoe' && (deck.length < 20 || needsReshuffle())) {
      deck = buildShoe();
    }

    hands[0] = [drawGameCard(), drawGameCard()];
    playerHand = hands[0]; // Update alias
    dealerHand = [drawGameCard(), drawGameCard()];
    renderHands();

    // Phase 4.6: Insurance side bet
    // If dealer shows Ace, offer insurance (half of original bet)
    // Insurance pays 2:1 if dealer has blackjack
    if (dealerHand[0].rank === 'A' && !hasNaturalBlackjack(playerHand)) {
      showInsurancePrompt();
      return; // Wait for insurance decision before continuing
    }

    // Continue with normal play (called after insurance decision or if no ace)
    continueAfterInsurance();
  }

  // Continue game after insurance decision (or if no insurance offered)
  function continueAfterInsurance() {
    // Check for immediate natural blackjacks
    if (hasNaturalBlackjack(playerHand) || hasNaturalBlackjack(dealerHand)) {
      gameOver = true;
      renderHands();
      checkWinner();
      updateButtons(false, false, false, true);
    } else {
      // Enable double down on initial hand (2 cards, total 9-11 recommended but allowed on any)
      const canDouble = playerHand.length === 2 && !isDoubledDown;
      updateButtons(true, true, canDouble, false);
    }
  }

  // Show insurance prompt
  function showInsurancePrompt() {
    insurancePromptActive = true;
    const insuranceCost = Math.floor(baseBet / 2);

    const promptEl = document.getElementById('insurance-prompt');
    const costEl = document.getElementById('insurance-cost');

    if (costEl) {
      costEl.textContent = `${insuranceCost} CC`;
    }

    if (promptEl) {
      promptEl.classList.remove('hidden');
    }

    // Disable game buttons while insurance prompt is active
    updateButtons(false, false, false, false);
  }

  // Hide insurance prompt
  function hideInsurancePrompt() {
    insurancePromptActive = false;
    const promptEl = document.getElementById('insurance-prompt');
    if (promptEl) {
      promptEl.classList.add('hidden');
    }
  }

  // Player takes insurance
  function takeInsurance() {
    const insuranceCost = Math.floor(baseBet / 2);

    // Check if player can afford insurance
    if (getCatnipBalance() < insuranceCost) {
      showStatus('Cannot Afford üí∏', 'Not enough CatnipCoin for insurance.', 'lose');
      setTimeout(() => {
        hideStatus();
        hideInsurancePrompt();
        continueAfterInsurance();
      }, 1500);
      return;
    }

    // Deduct insurance bet
    subtractCatnip(insuranceCost, 'Blackjack insurance');
    showCatnipChange(-insuranceCost, 'Insurance');

    insuranceBet = insuranceCost;
    insuranceTaken = true;

    hideInsurancePrompt();

    // Check if dealer has blackjack immediately
    if (hasNaturalBlackjack(dealerHand)) {
      // Dealer has blackjack - insurance pays 2:1
      const insurancePayout = insuranceBet * 3; // Original bet + 2:1 winnings
      addCatnip(insurancePayout, 'Insurance payout');
      showCatnipChange(insurancePayout, 'Insurance wins!');
      showStatus('Insurance Pays! üõ°Ô∏è', `Dealer has Blackjack. Insurance pays ${insurancePayout} CC.`, 'win');

      setTimeout(() => {
        hideStatus();
        gameOver = true;
        renderHands();
        checkWinner();
        updateButtons(false, false, false, true);
      }, 2000);
    } else {
      // Dealer doesn't have blackjack - insurance lost
      showStatus('No Blackjack', 'Dealer does not have Blackjack. Insurance lost.', 'lose');
      setTimeout(() => {
        hideStatus();
        continueAfterInsurance();
      }, 1500);
    }
  }

  // Player declines insurance
  function declineInsurance() {
    insuranceTaken = false;
    insuranceBet = 0;

    hideInsurancePrompt();

    // Check if dealer has blackjack (even insurance, game could end)
    if (hasNaturalBlackjack(dealerHand)) {
      gameOver = true;
      renderHands();
      checkWinner();
      updateButtons(false, false, false, true);
    } else {
      continueAfterInsurance();
    }
  }

  // Hit
  function hit() {
    // Add card to current active hand
    hands[activeHandIndex].push(drawGameCard());
    playerHand = hands[activeHandIndex]; // Keep alias in sync
    renderHands();

    const handTotal = calculateTotal(hands[activeHandIndex]);

    if (handTotal > 21) {
      // Bust on this hand
      if (isSplitGame) {
        // In split game, mark this hand as lost and move to next
        handResults[activeHandIndex] = 'lose';
        renderHands();
        setTimeout(() => moveToNextHand(), 500);
      } else {
        // Single hand game - game over
        gameOver = true;
        renderHands();
        checkWinner();
      }
    } else if (handTotal === 21) {
      // Auto-stand on 21
      if (isSplitGame) {
        moveToNextHand();
      } else {
        stand();
      }
    }
  }

  // Stand
  function stand() {
    updateButtons(false, false, false, false);

    if (isSplitGame) {
      // Move to next hand in split game
      moveToNextHand();
    } else {
      dealerPlay();
    }
  }

  // Double Down
  function doubleDown() {
    // Only allowed on first decision with 2 cards
    if (playerHand.length !== 2 || isDoubledDown || gameOver) {
      return;
    }

    // Deduct additional bet amount
    subtractCatnip(baseBet, 'Blackjack double down');

    // Mark as doubled down
    isDoubledDown = true;

    // Deal exactly one card
    playerHand.push(drawGameCard());
    renderHands();

    // Disable all action buttons
    updateButtons(false, false, false, false);

    // Check if busted
    const playerTotal = calculateTotal(playerHand);
    if (playerTotal > 21) {
      gameOver = true;
      renderHands();
      checkWinner();
    } else {
      // Forced stand after double down
      dealerPlay();
    }
  }
  
  // Split - Full implementation (Phase 4.6) with re-splitting support
  function split() {
    if (!canSplit() || !canAffordSplit() || gameOver) {
      return;
    }

    // Deduct additional bet for new hand
    subtractCatnip(baseBet, 'Blackjack split');
    showCatnipChange(-baseBet, 'Split bet');

    // Get the current hand being split
    const currentHand = hands[activeHandIndex];
    const firstCard = currentHand[0];
    const secondCard = currentHand[1];

    // Check if splitting aces
    const isSplittingAces = firstCard.rank === 'A';
    if (isSplittingAces) {
      splitAces = true; // Track that we have split aces this game
    }

    // Replace current hand with first card only
    hands[activeHandIndex] = [firstCard];

    // Insert new hand right after current (for proper play order)
    const newHandIndex = activeHandIndex + 1;
    hands.splice(newHandIndex, 0, [secondCard]);
    bets.splice(newHandIndex, 0, baseBet);
    handDoubled.splice(newHandIndex, 0, false);
    handResults.splice(newHandIndex, 0, null);
    handFromAces.splice(newHandIndex, 0, isSplittingAces);

    // Mark current hand as from aces too if splitting aces
    if (isSplittingAces) {
      handFromAces[activeHandIndex] = true;
    }

    isSplitGame = true;

    // Deal one card to each of the two hands that were just split
    hands[activeHandIndex].push(drawGameCard());
    hands[newHandIndex].push(drawGameCard());

    // Update playerHand alias
    playerHand = hands[activeHandIndex];

    renderHands();

    // Special case: Split aces get only one card each, then auto-stand both
    if (isSplittingAces) {
      showStatus('Split Aces ‚ô†‚ô•', 'Split aces receive one card each and automatically stand.', 'push');

      // Move past both ace hands to either next non-ace hand or dealer
      setTimeout(() => {
        hideStatus();
        // Skip all hands that are from ace splits (they auto-stand)
        while (activeHandIndex < hands.length - 1 && handFromAces[activeHandIndex]) {
          activeHandIndex++;
        }
        // If the next hand is also from aces, move to dealer
        if (handFromAces[activeHandIndex] || activeHandIndex >= hands.length - 1) {
          dealerPlay();
        } else {
          // There's a non-ace hand to play
          playerHand = hands[activeHandIndex];
          renderHands();
          updateButtons(true, true, canSplit() && canAffordSplit(), false);
        }
      }, 1500);
      return;
    }

    // Check for 21 on current hand (not natural blackjack after split)
    if (calculateTotal(hands[activeHandIndex]) === 21) {
      // Auto-move to next hand
      moveToNextHand();
    } else {
      // Enable play on current hand
      // Allow re-split if we got another pair and haven't hit max hands
      const canReSplit = canSplit() && canAffordSplit();
      updateButtons(true, true, canReSplit, false);
    }
  }

  // Move to next hand after current hand is done
  function moveToNextHand() {
    activeHandIndex++;

    if (activeHandIndex >= hands.length) {
      // All hands played, dealer's turn
      dealerPlay();
    } else {
      // Skip hands from ace splits (they auto-stand with 1 card dealt)
      if (handFromAces[activeHandIndex] && hands[activeHandIndex].length === 2) {
        setTimeout(() => moveToNextHand(), 300);
        return;
      }

      // Update playerHand alias
      playerHand = hands[activeHandIndex];
      renderHands();

      // Check for 21 on this hand
      if (calculateTotal(hands[activeHandIndex]) === 21) {
        setTimeout(() => moveToNextHand(), 500);
      } else {
        // Check if this hand can be re-split (got another pair)
        const canReSplit = canSplit() && canAffordSplit();
        updateButtons(true, true, canReSplit, false);
      }
    }
  }

  // Initialize
  // Update mode description UI
  function updateModeUI() {
    const descEl = document.getElementById('deckModeDesc');
    const labelEl = document.getElementById('currentModeLabel');
    const deckCountSelect = document.getElementById('deckCountSelect') as HTMLSelectElement;
    const reshuffleOptions = document.getElementById('reshuffleOptions');

    if (descEl) descEl.textContent = modeDescriptions[deckMode];
    if (labelEl) {
      labelEl.textContent = modeLabels[deckMode];
      const parentP = labelEl.parentElement;
      if (parentP) {
        parentP.innerHTML = `<strong style="color: var(--text-primary);">Current Mode:</strong> <span id="currentModeLabel">${modeLabels[deckMode]}</span> ‚Äî ${modeDescriptions[deckMode]}`;
      }
    }

    if (deckCountSelect) {
      deckCountSelect.disabled = deckMode === 'infinite';
      deckCountSelect.style.opacity = deckMode === 'infinite' ? '0.5' : '1';
    }

    if (reshuffleOptions) {
      reshuffleOptions.style.display = deckMode === 'shoe' ? 'block' : 'none';
    }
  }

  // Build the shoe based on current settings
  function buildShoe(): Card[] {
    const baseDecks: Card[] = [];
    for (let i = 0; i < deckCount; i++) {
      baseDecks.push(...generateStandardDeck());
    }
    return shuffleDeck(baseDecks);
  }

  // Check if shoe needs reshuffling
  function needsReshuffle(): boolean {
    if (deckMode !== 'shoe') return false;
    const totalCards = deckCount * 52;
    const cardsUsed = totalCards - deck.length;
    return cardsUsed / totalCards >= reshuffleThreshold;
  }

  // Draw a card based on current deck mode
  function drawGameCard(): Card {
    if (deckMode === 'infinite') {
      const freshDeck = generateStandardDeck();
      return freshDeck[Math.floor(Math.random() * freshDeck.length)];
    }

    if (deckMode === 'fresh') {
      if (deck.length === 0) {
        deck = shuffleDeck(generateStandardDeck());
      }
      return deck.pop()!;
    }

    // Shoe mode
    if (deck.length < 20 || needsReshuffle()) {
      deck = buildShoe();
    }
    return deck.pop()!;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const dealBtn = document.getElementById('deal-btn');
    const dealAgainBtn = document.getElementById('deal-again-btn');
    const hitBtn = document.getElementById('hit-btn');
    const standBtn = document.getElementById('stand-btn');
    const splitBtn = document.getElementById('split-btn');
    const doubleBtn = document.getElementById('double-btn');

    if (dealBtn) dealBtn.addEventListener('click', deal);
    if (dealAgainBtn) dealAgainBtn.addEventListener('click', deal);
    if (hitBtn) hitBtn.addEventListener('click', hit);
    if (standBtn) standBtn.addEventListener('click', stand);
    if (splitBtn) splitBtn.addEventListener('click', split);
    if (doubleBtn) doubleBtn.addEventListener('click', doubleDown);

    // Insurance buttons
    const insuranceYesBtn = document.getElementById('insurance-yes-btn');
    const insuranceNoBtn = document.getElementById('insurance-no-btn');
    if (insuranceYesBtn) insuranceYesBtn.addEventListener('click', takeInsurance);
    if (insuranceNoBtn) insuranceNoBtn.addEventListener('click', declineInsurance);

    // Deck mode settings event listeners
    const deckModeSelect = document.getElementById('deckModeSelect') as HTMLSelectElement;
    const deckCountSelect = document.getElementById('deckCountSelect') as HTMLSelectElement;
    const reshuffleSelect = document.getElementById('reshuffleSelect') as HTMLSelectElement;

    if (deckModeSelect) {
      deckModeSelect.addEventListener('change', () => {
        deckMode = deckModeSelect.value as DeckMode;
        deck = buildShoe();
        updateModeUI();
        deal(); // Start fresh with new settings
      });
    }

    if (deckCountSelect) {
      deckCountSelect.addEventListener('change', () => {
        deckCount = parseInt(deckCountSelect.value, 10);
        deck = buildShoe();
        deal();
      });
    }

    if (reshuffleSelect) {
      reshuffleSelect.addEventListener('change', () => {
        reshuffleThreshold = parseFloat(reshuffleSelect.value);
      });
    }

    updateModeUI();

    // Initialize balance display
    updateBalanceDisplay();

    // Initial deal
    deal();
  });
</script>

<style>
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  button:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
</style>
