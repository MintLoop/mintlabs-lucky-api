---
// Dice Roller - Casino-Lite D6 Game
// Phase 4.6 - CasinoLayout integration

import CasinoLayout from "../../components/CasinoLayout.astro";

const title = "Dice Roller";
const description = "Roll casino-quality six-sided dice with true random results. Learn about dice probability, independence, and streaks.";
---

<CasinoLayout title={title} description={description} showBalance={false}>
  <!-- Controls Row -->
  <div class="flex flex-wrap items-center justify-between gap-4 p-4 rounded-xl" style="background: var(--surface-elevated);">
    <div class="flex items-center gap-3">
      <label for="diceCount" class="font-semibold text-sm" style="color: var(--text-primary);">
        Number of Dice:
      </label>
      <select
        id="diceCount"
        class="px-3 py-2 rounded-lg font-medium text-sm"
        style="background: var(--surface); color: var(--text-primary); border: 1px solid var(--border-primary);"
      >
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
    </div>

    <button
      id="rollButton"
      class="px-6 py-2.5 rounded-lg font-bold text-sm transition-all hover:scale-105"
      style="background: var(--accent-primary); color: var(--text-on-accent);"
    >
      ðŸŽ² Roll Dice
    </button>
  </div>

  <!-- Dice Display Area -->
  <div id="diceDisplay" class="p-8 rounded-xl min-h-[180px] flex flex-wrap gap-6 items-center justify-center" style="background: var(--surface-elevated);">
    <p class="text-center" style="color: var(--text-muted);">
      Click "Roll Dice" to begin
    </p>
  </div>

  <!-- Results Panel -->
  <div id="resultsPanel" class="p-4 rounded-xl hidden" style="background: var(--surface-elevated); border: 2px solid var(--accent-primary);">
    <div class="flex items-center justify-between">
      <div class="text-sm" style="color: var(--text-secondary);">
        Roll: <span id="diceValues" class="font-mono font-bold" style="color: var(--text-primary);">[--]</span>
      </div>
      <div id="totalDisplay" class="text-2xl font-bold" style="color: var(--accent-primary);">
        Total: 0
      </div>
    </div>
  </div>

  <!-- Roll History -->
  <div class="p-4 rounded-xl" style="background: var(--surface-elevated);">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-bold" style="color: var(--text-primary);">Recent Rolls</h3>
      <button
        id="clearHistory"
        class="px-3 py-1 rounded text-xs font-semibold transition-all"
        style="background: var(--surface); color: var(--text-muted); border: 1px solid var(--border-primary);"
      >
        Clear
      </button>
    </div>
    <div id="rollHistory" class="space-y-1 text-sm max-h-32 overflow-y-auto" style="color: var(--text-secondary);">
      <p style="color: var(--text-muted);">No rolls yet</p>
    </div>
  </div>

  <!-- Quick Reference -->
  <div class="p-4 rounded-xl" style="background: var(--surface-elevated);">
    <h3 class="text-sm font-bold mb-3" style="color: var(--text-primary);">ðŸŽ¯ D6 Probability</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
      <div class="p-3 rounded-lg text-center" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-lg font-bold" style="color: var(--accent-primary);">16.7%</div>
        <div style="color: var(--text-muted);">Each face (1d6)</div>
      </div>
      <div class="p-3 rounded-lg text-center" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-lg font-bold" style="color: var(--accent-primary);">7</div>
        <div style="color: var(--text-muted);">Most common (2d6)</div>
      </div>
      <div class="p-3 rounded-lg text-center" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-lg font-bold" style="color: var(--accent-primary);">2.78%</div>
        <div style="color: var(--text-muted);">Snake eyes (1+1)</div>
      </div>
      <div class="p-3 rounded-lg text-center" style="background: var(--surface); border: 1px solid var(--border-primary);">
        <div class="text-lg font-bold" style="color: var(--accent-primary);">16.7%</div>
        <div style="color: var(--text-muted);">Roll a 7 (2d6)</div>
      </div>
    </div>
    <p class="text-xs mt-3 text-center" style="color: var(--text-muted);">
      Each roll is independent. Past results don't affect future rolls.
    </p>
  </div>
</CasinoLayout>

<style is:global>
  /* Dice Styles - must be global for dynamically generated content */
  .dice-view {
    width: 4rem;
    height: 4rem;
    position: relative;
    border-radius: 12%;
    background: linear-gradient(145deg, #ffffff 0%, #e8e8e8 100%);
    border: 2px solid rgba(0, 0, 0, 0.1);
    box-shadow:
      0 4px 8px rgba(0, 0, 0, 0.15),
      inset 0 2px 4px rgba(255, 255, 255, 0.9),
      inset 0 -2px 4px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .dice-view:hover {
    transform: scale(1.05) translateY(-2px);
    box-shadow:
      0 8px 16px rgba(0, 0, 0, 0.2),
      inset 0 2px 4px rgba(255, 255, 255, 0.9),
      inset 0 -2px 4px rgba(0, 0, 0, 0.05);
  }

  .dice-face {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .pip {
    background: radial-gradient(circle, #1a1a1a 0%, #333 100%);
    border-radius: 50%;
    box-shadow:
      inset 0 2px 3px rgba(0, 0, 0, 0.4),
      0 1px 1px rgba(255, 255, 255, 0.3);
    position: absolute;
    width: 0.65rem;
    height: 0.65rem;
  }

  /* Pip positioning */
  .pip.center { top: 50%; left: 50%; transform: translate(-50%, -50%); }
  .pip.top-left { top: 18%; left: 18%; }
  .pip.top-right { top: 18%; right: 18%; }
  .pip.middle-left { top: 50%; left: 18%; transform: translateY(-50%); }
  .pip.middle-right { top: 50%; right: 18%; transform: translateY(-50%); }
  .pip.bottom-left { bottom: 18%; left: 18%; }
  .pip.bottom-right { bottom: 18%; right: 18%; }

  /* Rolling animation */
  .dice-view.rolling {
    animation: dice-roll 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
  }

  @keyframes dice-roll {
    0% { transform: rotate(0deg) scale(1); }
    15% { transform: rotate(-15deg) scale(1.1) translateY(-8px); }
    30% { transform: rotate(12deg) scale(1.05) translateX(4px); }
    45% { transform: rotate(-8deg) scale(1.08) translateY(-4px); }
    60% { transform: rotate(6deg) scale(1.03) translateX(-2px); }
    75% { transform: rotate(-3deg) scale(1.01); }
    90% { transform: rotate(1deg) scale(1); }
    100% { transform: rotate(0deg) scale(1); }
  }

  .dice-view.rolling .pip {
    animation: pip-flash 0.15s infinite;
  }

  @keyframes pip-flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Larger dice on bigger screens */
  @media (min-width: 640px) {
    .dice-view {
      width: 5rem;
      height: 5rem;
    }
    .pip {
      width: 0.8rem;
      height: 0.8rem;
    }
  }
</style>

<script>
  // Roll history
  let rollHistory: Array<{ dice: number[], total: number }> = [];

  // Pip layouts for each face
  const pipLayouts: Record<number, string[]> = {
    1: ['center'],
    2: ['top-left', 'bottom-right'],
    3: ['top-left', 'center', 'bottom-right'],
    4: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
    5: ['top-left', 'top-right', 'center', 'bottom-left', 'bottom-right'],
    6: ['top-left', 'top-right', 'middle-left', 'middle-right', 'bottom-left', 'bottom-right'],
  };

  // Generate dice HTML
  function generateDiceHTML(values: number[], isRolling: boolean = false): string {
    return values.map(value => {
      const pips = pipLayouts[value] || [];
      const pipHTML = pips.map(pos => `<div class="pip ${pos}"></div>`).join('');

      return `
        <div class="dice-view ${isRolling ? 'rolling' : ''}" role="img" aria-label="Dice showing ${value}">
          <div class="dice-face">
            ${pipHTML}
          </div>
        </div>
      `;
    }).join('');
  }

  // Roll dice with crypto RNG
  function rollDice(count: number): number[] {
    const results: number[] = [];
    const randomValues = new Uint32Array(count);
    crypto.getRandomValues(randomValues);

    for (let i = 0; i < count; i++) {
      results.push((randomValues[i] % 6) + 1);
    }

    return results;
  }

  // Display results
  function displayResults(dice: number[]) {
    const total = dice.reduce((sum, val) => sum + val, 0);
    const diceDisplay = document.getElementById('diceDisplay');
    const resultsPanel = document.getElementById('resultsPanel');
    const totalDisplay = document.getElementById('totalDisplay');
    const diceValues = document.getElementById('diceValues');

    if (diceDisplay) {
      diceDisplay.innerHTML = generateDiceHTML(dice, false);
    }

    if (resultsPanel && totalDisplay && diceValues) {
      resultsPanel.classList.remove('hidden');
      totalDisplay.textContent = `Total: ${total}`;
      diceValues.textContent = `[${dice.join(', ')}]`;
    }

    // Update history
    rollHistory.unshift({ dice: [...dice], total });
    if (rollHistory.length > 10) rollHistory.pop();
    updateHistory();
  }

  // Update roll history display
  function updateHistory() {
    const historyEl = document.getElementById('rollHistory');
    if (!historyEl) return;

    if (rollHistory.length === 0) {
      historyEl.innerHTML = '<p style="color: var(--text-muted);">No rolls yet</p>';
      return;
    }

    historyEl.innerHTML = rollHistory.map((roll, idx) => {
      const bg = idx === 0 ? 'var(--accent-primary)' : 'var(--surface)';
      const textColor = idx === 0 ? 'var(--text-on-accent)' : 'var(--text-secondary)';
      return `<div class="flex justify-between items-center px-3 py-1.5 rounded" style="background: ${bg}; color: ${textColor};">
        <span>${roll.dice.length}d6: [${roll.dice.join(', ')}]</span>
        <span class="font-bold">= ${roll.total}</span>
      </div>`;
    }).join('');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    const rollButton = document.getElementById('rollButton');
    const diceCountSelect = document.getElementById('diceCount') as HTMLSelectElement;
    const clearHistoryBtn = document.getElementById('clearHistory');
    const diceDisplay = document.getElementById('diceDisplay');

    if (rollButton && diceCountSelect && diceDisplay) {
      rollButton.addEventListener('click', () => {
        const count = parseInt(diceCountSelect.value, 10);

        // Show rolling animation with random faces
        const tempDice = Array(count).fill(0).map(() => Math.floor(Math.random() * 6) + 1);
        diceDisplay.innerHTML = generateDiceHTML(tempDice, true);

        // Wait for animation, then show actual results
        setTimeout(() => {
          const results = rollDice(count);
          displayResults(results);
        }, 600);
      });
    }

    if (clearHistoryBtn) {
      clearHistoryBtn.addEventListener('click', () => {
        rollHistory = [];
        updateHistory();
      });
    }
  });
</script>
