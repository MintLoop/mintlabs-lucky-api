---
import GeneratorForm from "../GeneratorForm.astro";
export interface Props { games?: any[] }
const { games = [] } = Astro.props;
---

<section class="demo-generator-container" id="demoGenWrap" aria-label="Lucky number generator">
  <div class="demo-generator-body">
    <GeneratorForm games={games} />
  </div>
</section>

<style>
#demoGenWrap { width: 100%; }
.demo-generator-container {
  background: var(--surface-generator-outer);
  color: var(--text-generator-primary, var(--text-strong));
  border: 1px solid var(--border-generator, color-mix(in srgb, var(--border-subtle) 75%, transparent 25%));
  box-shadow: var(--shadow-soft-md);
  border-radius: var(--radius-2xl);
  padding: clamp(var(--space-xs), 1.5vw, var(--space-md));
  overflow: hidden;
}
.demo-generator-body {
  background: color-mix(in srgb, var(--surface-generator-inner) 92%, var(--surface-generator-outer) 8%);
  border-radius: calc(var(--radius-2xl) - var(--space-xs));
  padding: clamp(var(--space-md), 2vw, var(--space-lg));
  color: var(--text-generator-primary, var(--text-strong));
}
.demo-generator-container .theme-text-secondary { color: var(--text-generator-muted, var(--text-muted)); }

/* Modernized result chips for demo only */
#results .result-card .result-chip {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  /* Use color-mix with accent token and fall back to rgb-based rgba */
  background: color-mix(in srgb, var(--accent-primary) 15%, transparent);
  background: rgba(var(--accent-primary-rgb), 0.12);
  border: 1px solid var(--accent-primary);
  color: var(--accent-primary);
  font-weight: 700;
  box-shadow: none;
  margin: 0 0.25rem;
}

#results .result-card { gap: 0.5rem; }
#results .result-card .odds-link { color: var(--accent-primary); font-weight: 600; }

/* Result-card uses dedicated result tokens */
#results .result-card { border: 1px solid var(--border-results); background: var(--surface-results); padding: 0.75rem; border-radius: var(--radius-md); }

/* Improve contrast for generated number list */
#results .result-card b { color: var(--text-primary); font-weight: 700; }
#results .result-card .odds-number { font-weight: 700; color: var(--text-results-primary); }

/* Responsive adjustments */
@media (max-width: 640px) {
  .demo-generator-container { padding: var(--space-sm); }
  .demo-generator-body { padding: var(--space-md); }
  #results .result-card { padding: 0.6rem; }
}

#results { display: flex; flex-direction: column; gap: 0.6rem; }

/* Inputs and labels: ensure generator inputs use generator tokens */
.demo-generator-container label span { color: var(--text-generator-primary, var(--text-strong)); }
.demo-generator-container input, .demo-generator-container select, .demo-generator-container textarea { background: var(--surface-generator-inner); color: var(--text-generator-primary, var(--text-body)); border: 1px solid var(--border-generator, var(--border-subtle)); }
.demo-generator-container .theme-input-bg { background: var(--surface-generator-inner) !important; }
.demo-generator-container .theme-border-primary { border-color: var(--border-generator) !important; }
.demo-generator-container input:focus, .demo-generator-container select:focus, .demo-generator-container textarea:focus { outline: none; box-shadow: 0 0 0 6px rgba(var(--accent-primary-rgb), 0.10); border-color: var(--accent-primary); }

.demo-generator-container #genForm {
  margin: 0;
  padding: 0;
  background: transparent;
  border-radius: 0;
  box-shadow: none;
  border: none;
}
.demo-generator-container #genForm.theme-bg-card { background: transparent; }

</style>

<script is:inline>
  // Demo-only: compute and set stable generator surface tokens per theme to guarantee readability
  (function(){
    function hexToRgb(hex){
      try{
        if(!hex) return null;
        const val = hex.trim();
        if (val.startsWith('rgb')) {
          const nums = val.replace(/[^\d,]/g, '').split(',').map((n) => parseInt(n, 10)).filter((n) => !Number.isNaN(n));
          if (nums.length >= 3) return { r: nums[0], g: nums[1], b: nums[2] };
        }
        let clean = val;
        if(clean.indexOf('#')===0) clean=clean.slice(1);
        if(clean.length===3) clean = clean.split('').map(c=>c+c).join('');
        const n=parseInt(clean,16);
        if(Number.isNaN(n)) return null;
        return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
      }catch(e){return null}
    }
    function mixWithWhite({r,g,b}, pct){ const f=Math.max(0,Math.min(1,pct)); return { r: Math.round(r+(255-r)*f), g: Math.round(g+(255-g)*f), b: Math.round(b+(255-b)*f) }; }
    function mixWithBlack({r,g,b}, pct){ const f=Math.max(0,Math.min(1,pct)); return { r: Math.round(r*(1-f)), g: Math.round(g*(1-f)), b: Math.round(b*(1-f)) }; }
    const rgbString = ({r,g,b}) => `rgb(${r}, ${g}, ${b})`;
    function luminance({r,g,b}){ const Rs = r/255; const Gs=g/255; const Bs=b/255; const R = Rs<=0.03928 ? Rs/12.92 : Math.pow((Rs+0.055)/1.055,2.4); const G = Gs<=0.03928 ? Gs/12.92 : Math.pow((Gs+0.055)/1.055,2.4); const B = Bs<=0.03928 ? Bs/12.92 : Math.pow((Bs+0.055)/1.055,2.4); return 0.2126*R + 0.7152*G + 0.0722*B; }
    function readColor(names, fallback) {
      const computed = getComputedStyle(document.documentElement);
      for (const n of names) {
        const v = computed.getPropertyValue(n);
        const parsed = hexToRgb(v);
        if (parsed) return parsed;
      }
      return hexToRgb(fallback) || { r: 24, g: 36, b: 52 };
    }
    function chooseDemoGeneratorColors(){
      const computed = getComputedStyle(document.documentElement);
      const base = readColor(['--surface-page','--bg-base','--bg-primary','--bg-surface-elevated'], '#0f172a');
          const accent = computed.getPropertyValue('--accent-primary') || '#10b981';
      const accentRgb = hexToRgb(accent) || {r:16,g:185,b:129};
      const lum = luminance(base);
      // Bias toward lighter lifted surfaces for dark themes; keep subtle elevation on light themes
      if(lum < 0.55){
        const outer = mixWithWhite(base, 0.22); // lift outer above page
        const inner = mixWithWhite(base, 0.34); // inner lighter than outer
        const border = mixWithWhite(base, 0.48);
        return {
          inner: rgbString(inner), outer: rgbString(outer), text:'#f8fafc', muted:'#d5dde9', border: rgbString(border), accentRgb
        };
      } else {
        const outer = mixWithWhite(base, 0.08);
        const inner = mixWithWhite(base, 0.16);
        const border = mixWithBlack(inner, 0.10);
        return {
          inner: rgbString(inner), outer: rgbString(outer), text:'#0f172a', muted:'#4b5563', border: rgbString(border), accentRgb
        };
      }
    }
    function apply(){
      const wrap=document.getElementById('demoGenWrap'); if(!wrap) return;
      const c = chooseDemoGeneratorColors();
      wrap.style.setProperty('--surface-generator-inner', c.inner);
      wrap.style.setProperty('--surface-generator-outer', c.outer);
      wrap.style.setProperty('--text-generator-primary', c.text);
      wrap.style.setProperty('--text-generator-muted', c.muted);
      // Maintain demo tokens parity
      wrap.style.setProperty('--text-strong', c.text);
      wrap.style.setProperty('--text-body', c.text);
      wrap.style.setProperty('--text-muted', c.muted);
      wrap.style.setProperty('--border-generator', c.border);
      // Also set result colors to ensure contrast
      wrap.style.setProperty('--surface-results', c.inner);
      wrap.style.setProperty('--text-results-primary', c.text);
      wrap.style.setProperty('--text-results-muted', c.muted);
      wrap.style.setProperty('--border-results', c.border);
      // Update optional helper: accent RGB (comma list) for rgba fallbacks
      wrap.style.setProperty('--accent-primary-rgb', `${c.accentRgb.r}, ${c.accentRgb.g}, ${c.accentRgb.b}`);
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', apply); else apply();
    // reapply on theme change: listen for ThemePicker event or data-theme attribute change
    window.addEventListener('themeChanged', apply);
    const obs = new MutationObserver((m)=>{ for(const r of m){ if(r.attributeName==='data-theme') apply(); } });
    obs.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
  })();
</script>
