---
// CardView Component - Reusable Card Renderer
// Phase 4 - Casino-Lite Visual System

import type { Card, DeckTheme, SuitSet } from '../../types/cards';
import { getCardColor, formatCard } from '../../utils/cardDeck';

interface Props {
  card: Card;
  theme: DeckTheme;
  suitSet: SuitSet;
  faceDown?: boolean;
  size?: 'sm' | 'md' | 'lg';
  class?: string;
}

const { card, theme, suitSet, faceDown = false, size = 'md', class: className = '' } = Astro.props;

// Size mappings (consistent widths for responsive design)
const sizeClasses = {
  sm: 'w-[72px] sm:w-[80px] text-xs',
  md: 'w-[88px] sm:w-[96px] text-sm',
  lg: 'w-[104px] sm:w-[112px] text-base',
};

// Get suit icon
const suitIcon = suitSet.icons[card.suit];
const isEmoji = !suitIcon.startsWith('/');

// Determine suit color
const cardColor = getCardColor(card.suit);
const colorClass = cardColor === 'red' ? 'text-red-600' : 'text-slate-900';

// Compute front/back image sources (Phase 4.3.x)
const frontSrc = theme.frontBySuit?.[card.suit] ?? theme.frontImage ?? null;
const backSrc = theme.backImage ?? null;

// Aria label for accessibility
const ariaLabel = faceDown ? 'Face down card' : formatCard(card);
---

<div
  class={`relative aspect-[3/4] overflow-hidden ${sizeClasses[size]} ${theme.cardFrameClass} ${className}`}
  role="img"
  aria-label={ariaLabel}
>
  {faceDown ? (
    <!-- Card Back (image or fallback pattern) -->
    <>
      {backSrc ? (
        <div
          class="absolute inset-0 bg-cover bg-center"
          style={`background-image: url('${backSrc}')`}
        />
      ) : (
        <div class={`absolute inset-0 ${theme.backPattern || 'bg-emerald-700'} flex items-center justify-center`}>
          <div class="text-white text-2xl opacity-20">ðŸŽ´</div>
        </div>
      )}
    </>
  ) : (
    <!-- Card Front (image layer + rank/suit overlay) -->
    <>
      {/* Background Image Layer */}
      {frontSrc ? (
        <div
          class="absolute inset-0 bg-cover bg-center"
          style={`background-image: url('${frontSrc}')`}
        />
      ) : theme.background ? (
        <div class={`absolute inset-0 ${theme.background}`} />
      ) : (
        <div class="absolute inset-0 bg-white" />
      )}

      {/* Rank/Suit Overlay (always on top) */}
      <div class="absolute inset-0 pointer-events-none">
        <!-- Top-left corner -->
        <div class={`absolute top-[8%] left-[10%] flex flex-col items-start leading-none ${colorClass}`}>
          <span class={`${theme.rankFontClass} ${size === 'sm' ? 'text-base' : size === 'md' ? 'text-xl' : 'text-2xl'}`}>
            {card.rank}
          </span>
          {isEmoji ? (
            <span class={size === 'sm' ? 'text-xs' : size === 'md' ? 'text-sm' : 'text-base'}>
              {suitIcon}
            </span>
          ) : (
            <img 
              src={suitIcon} 
              alt={card.suit}
              class={size === 'sm' ? 'w-3 h-3' : size === 'md' ? 'w-4 h-4' : 'w-5 h-5'}
            />
          )}
        </div>

        <!-- Center suit icon -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
          {isEmoji ? (
            <span class={`${colorClass} ${size === 'sm' ? 'text-2xl' : size === 'md' ? 'text-4xl' : 'text-5xl'}`}>
              {suitIcon}
            </span>
          ) : (
            <img 
              src={suitIcon} 
              alt={card.suit}
              class={size === 'sm' ? 'w-8 h-8' : size === 'md' ? 'w-12 h-12' : 'w-16 h-16'}
            />
          )}
        </div>

        <!-- Bottom-right corner (rotated) -->
        <div class={`absolute bottom-[8%] right-[10%] flex flex-col items-end leading-none rotate-180 ${colorClass}`}>
          <span class={`${theme.rankFontClass} ${size === 'sm' ? 'text-base' : size === 'md' ? 'text-xl' : 'text-2xl'}`}>
            {card.rank}
          </span>
          {isEmoji ? (
            <span class={size === 'sm' ? 'text-xs' : size === 'md' ? 'text-sm' : 'text-base'}>
              {suitIcon}
            </span>
          ) : (
            <img 
              src={suitIcon} 
              alt={card.suit}
              class={size === 'sm' ? 'w-3 h-3' : size === 'md' ? 'w-4 h-4' : 'w-5 h-5'}
            />
          )}
        </div>
      </div>
    </>
  )}
</div>

<style>
  /* Optional: Add flip animation for card reveals */
  .card-flip {
    animation: flip 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes flip {
    0% {
      transform: rotateY(0deg);
    }
    50% {
      transform: rotateY(90deg);
    }
    100% {
      transform: rotateY(0deg);
    }
  }
</style>
