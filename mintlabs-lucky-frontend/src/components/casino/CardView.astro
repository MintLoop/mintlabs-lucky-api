---
// CardView Component - Reusable Card Renderer
// Phase 4 - Casino-Lite Visual System

import type { Card, DeckTheme, SuitSet } from '../../types/cards';
import { getCardColor, formatCard } from '../../utils/cardDeck';

interface Props {
  card: Card;
  theme: DeckTheme;
  suitSet: SuitSet;
  faceDown?: boolean;
  size?: 'sm' | 'md' | 'lg';
  class?: string;
}

const { card, theme, suitSet, faceDown = false, size = 'md', class: className = '' } = Astro.props;

// Debug mode for alignment QA (set to true to see guides)
const debug = false;

// Asset resolver - ensures JPEG fallback (Phase 4.3.z + 4.5)
const resolveAsset = (src: string | undefined): string | null => {
  if (!src) return null;
  return src
    .replace('.webp', '.jpeg')
    .replace('.jpg', '.jpeg')
    .replace('.svg', '.jpeg');
};

// Size mappings - consistent widths, aspect ratio controls height (Phase 4.4)
const sizeClass = 
  size === 'sm' ? 'w-[60px] sm:w-[70px]' :
  size === 'lg' ? 'w-[100px] sm:w-[110px]' :
                  'w-[80px] sm:w-[90px]'; // md default

// Get suit icon
const suitIcon = suitSet.icons[card.suit];
const isEmoji = !suitIcon.startsWith('/');

// Determine suit color
const cardColor = getCardColor(card.suit);
const colorClass = cardColor === 'red' ? 'text-red-600' : 'text-slate-900';

// Compute front/back image sources with WebP + fallback (Phase 4.5)
const frontSrcWebP = theme.frontBySuitWebP?.[card.suit] ?? theme.frontImageWebP;
const frontSrcFallback = resolveAsset(theme.frontBySuit?.[card.suit] ?? theme.frontImage);
const backSrcWebP = theme.backImageWebP;
const backSrcFallback = resolveAsset(theme.backImage);

// Select appropriate image sources based on face direction
const cardImageWebP = faceDown ? backSrcWebP : frontSrcWebP;
const cardImageFallback = faceDown ? backSrcFallback : frontSrcFallback;

// Aria label for accessibility
const ariaLabel = faceDown ? 'Face down card' : formatCard(card);
---

<!-- Card Shell: consistent frame across all themes (Phase 4.4) -->
<div
  class={`relative ${sizeClass} aspect-[3/4] ${theme.cardFrameClass} ${className} transition-transform duration-200 hover:-translate-y-0.5 hover:shadow-lg`}
  role="img"
  aria-label={ariaLabel}
>
  {/* Inner mask: clips image to card shape */}
  <div class="absolute inset-0 rounded-xl overflow-hidden">
    {/* Loading skeleton (Phase 4.5) */}
    <div class="absolute inset-0 bg-gradient-to-br from-slate-200 to-slate-300 animate-pulse card-skeleton"></div>
    
    {/* Background image/pattern with padding for visible border */}
    {cardImageWebP || cardImageFallback ? (
      <div class="absolute inset-0 p-[2%]">
        <picture class="w-full h-full block">
          {cardImageWebP && (
            <source type="image/webp" srcset={cardImageWebP} />
          )}
          <img
            src={cardImageFallback || ''}
            alt={faceDown ? 'Card back' : `${card.rank} of ${card.suit}`}
            class="w-full h-full object-cover card-image"
            loading="lazy"
            onerror="this.parentElement.parentElement.classList.add('card-error'); this.style.display='none';"
            onload="this.parentElement.parentElement.previousElementSibling.style.display='none';"
          />
        </picture>
      </div>
    ) : theme.background && !faceDown ? (
      <div class={`absolute inset-0 ${theme.background}`} />
    ) : faceDown ? (
      <div class={`absolute inset-0 ${theme.backPattern || 'bg-emerald-700'} flex items-center justify-center`}>
        <div class="text-white text-2xl opacity-20">üé¥</div>
      </div>
    ) : (
      <div class="absolute inset-0 bg-white" />
    )}
    
    {/* Error fallback (Phase 4.5) */}
    <div class="card-error-fallback hidden absolute inset-0 bg-gradient-to-br from-slate-300 to-slate-400 flex items-center justify-center">
      <div class="text-center text-slate-600 text-xs px-2">
        <div class="text-2xl mb-1">‚ö†Ô∏è</div>
        <div>Image failed</div>
      </div>
    </div>
  </div>

  {/* Rank/Suit Overlay (face-up cards only) */}
  {!faceDown && (
    <div class="absolute inset-0 pointer-events-none">
      {/* Top-left corner */}
      <div class="absolute top-[6%] left-[7%]">
        <div class={`flex flex-col items-center justify-center leading-none text-[0.7rem] sm:text-[0.8rem] drop-shadow-[0_0_3px_rgba(0,0,0,0.5)] ${colorClass}`}>
          <span class={theme.rankFontClass}>{card.rank}</span>
          {isEmoji ? (
            <span>{suitIcon}</span>
          ) : (
            <img 
              src={suitIcon} 
              alt={card.suit}
              class="w-3 h-3 sm:w-4 sm:h-4"
            />
          )}
        </div>
      </div>

      {/* Center suit icon */}
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
        {isEmoji ? (
          <span class={`text-[1.8rem] sm:text-[2rem] opacity-80 drop-shadow-[0_0_4px_rgba(0,0,0,0.6)] ${colorClass}`}>
            {suitIcon}
          </span>
        ) : (
          <img 
            src={suitIcon} 
            alt={card.suit}
            class="w-10 h-10 sm:w-12 sm:h-12 opacity-80"
            style="filter: drop-shadow(0 0 4px rgba(0,0,0,0.6));"
          />
        )}
      </div>

      {/* Bottom-right corner (rotated) */}
      <div class="absolute bottom-[6%] right-[7%] rotate-180">
        <div class={`flex flex-col items-center justify-center leading-none text-[0.7rem] sm:text-[0.8rem] drop-shadow-[0_0_3px_rgba(0,0,0,0.5)] ${colorClass}`}>
          <span class={theme.rankFontClass}>{card.rank}</span>
          {isEmoji ? (
            <span>{suitIcon}</span>
          ) : (
            <img 
              src={suitIcon} 
              alt={card.suit}
              class="w-3 h-3 sm:w-4 sm:h-4"
            />
          )}
        </div>
      </div>
    </div>
  )}

  {/* Debug guides (Phase 4.4 - toggle for alignment QA) */}
  {debug && (
    <>
      <div class="absolute inset-0 border border-red-500"></div>
      <div class="absolute top-[6%] left-[7%] w-4 h-4 border border-blue-500"></div>
      <div class="absolute bottom-[6%] right-[7%] w-4 h-4 border border-green-500"></div>
      <div class="absolute top-1/2 left-1/2 w-4 h-4 -translate-x-1/2 -translate-y-1/2 border border-yellow-500"></div>
    </>
  )}
</div>

<style>
  /* Loading skeleton animation (Phase 4.5) */
  .card-skeleton {
    animation: skeleton-pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes skeleton-pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  
  /* Image loaded state - hide skeleton */
  .card-image {
    position: relative;
    z-index: 1;
  }
  
  /* Error state - show fallback */
  .card-error .card-error-fallback {
    display: flex !important;
    z-index: 2;
  }
  
  /* Optional: Add flip animation for card reveals */
  .card-flip {
    animation: flip 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes flip {
    0% {
      transform: rotateY(0deg);
    }
    50% {
      transform: rotateY(90deg);
    }
    100% {
      transform: rotateY(0deg);
    }
  }
</style>
